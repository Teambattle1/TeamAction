            </div>

            {/* RIGHT MAIN CANVAS */}
            <div ref={editorRootRef} className="flex-1 relative flex flex-col bg-[#050505]">
                {/* Drawer Toggle Button - Always Visible */}
                <button
                    onClick={() => setIsDrawerOpen(!isDrawerOpen)}
                    className="absolute left-0 top-1/2 -translate-y-1/2 z-30 bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-r-2xl shadow-2xl transition-all active:scale-95"
                    title={isDrawerOpen ? "Close Settings" : "Open Settings"}
                >
                    {isDrawerOpen ? <ChevronLeft className="w-6 h-6" /> : <ChevronRight className="w-6 h-6" />}
                </button>

                {/* Top Overlay Bar - Title, Zone Tabs (centered), and Home */}
                <div className="absolute top-0 left-0 right-0 z-10">
                    <div className="p-4 flex items-center gap-4 relative">
                        {/* Left: Title */}
                        <div className="hidden flex items-center gap-3 bg-slate-900/80 backdrop-blur-sm border border-orange-500/30 rounded-xl px-4 py-2 shadow-xl pointer-events-auto flex-shrink-0">
                            <LayoutGrid className="w-5 h-5 text-orange-500" />
                            <div>
                                <h1 className="text-sm font-black text-white uppercase tracking-widest">
                                    PLAYZONE EDITOR
                                </h1>
                                <p className="text-[9px] text-slate-400 font-bold uppercase tracking-wider">
                                    {game.playgrounds?.length || 0} ZONES ACTIVE
                                </p>
                            </div>
                        </div>

                        {/* Center: Zone Tabs - Centered in Editor Window */}
                        <div className="absolute left-1/2 -translate-x-1/2 flex gap-2 overflow-x-auto pointer-events-auto hide-scrollbar">
                            {/* ADD NEW Button First (hide when editing/creating playzone templates) */}
                            {!isTemplateMode && (
                                <button
                                    onClick={addNewZone}
                                    className="px-4 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wide whitespace-nowrap transition-all flex-shrink-0 bg-green-600 hover:bg-green-700 text-white shadow-lg border-2 border-green-500 flex items-center gap-2"
                                    title="Add a new zone to the game"
                                >
                                    <Plus className="w-4 h-4" /> ADD NEW
                                </button>
                            )}

                            {/* Zone Tabs */}
                            {game.playgrounds?.map((pg, index) => {
                                const TabIcon = ICON_COMPONENTS[pg.iconId || 'default'] || ICON_COMPONENTS.default;
                                return (
                                <button
                                    key={pg.id}
                                    onClick={() => setActivePlaygroundId(pg.id)}
                                    className={`px-4 py-2.5 rounded-xl text-xs font-bold uppercase tracking-wide whitespace-nowrap transition-all flex-shrink-0 flex items-center gap-2 shadow-lg border-2 ${
                                        activePlaygroundId === pg.id
                                            ? 'bg-orange-600 text-white border-orange-500 shadow-orange-500/50'
                                            : 'bg-slate-800/80 backdrop-blur-sm text-slate-300 border-slate-700 hover:text-white hover:bg-slate-700 hover:border-slate-600'
                                    }`}
                                    title={`Switch to ${pg.title}`}
                                >
                                    <TabIcon className="w-3 h-3 flex-shrink-0" />
                                    <span className="text-[10px] font-black opacity-70">{String(index + 1).padStart(2, '0')}</span>
                                    {pg.title}
                                </button>
                                );
                            })}
                        </div>

                        {/* Right: Home Button */}
                        <button
                            onClick={onHome}
                            className="p-3 bg-slate-900/80 backdrop-blur-sm hover:bg-slate-800 text-slate-400 hover:text-white rounded-full shadow-xl border border-slate-700 transition-all pointer-events-auto flex-shrink-0 ml-auto"
                            title="Return Home"
                        >
                            <ArrowLeft className="w-5 h-5" />
                        </button>
                    </div>
                </div>

                {/* Draggable ORIENTATION Toolbar - HIDDEN - Now in left drawer */}
                <div
                    className="hidden absolute z-[1100] pointer-events-auto touch-none"
                    style={{ left: orientationToolbarPos.x, top: orientationToolbarPos.y }}
                    onPointerDown={handleOrientationPointerDown}
                    onPointerMove={handleOrientationPointerMove}
                    onPointerUp={handleOrientationPointerUp}
                >
                    <div className="bg-black/40 backdrop-blur-sm border border-orange-500/30 rounded-lg shadow-2xl p-2 cursor-move group relative">
                        <div className="absolute -top-3 left-1/2 -translate-x-1/2 text-orange-400 opacity-0 group-hover:opacity-100 transition-opacity bg-black/60 rounded-full px-2 border border-orange-500/30 pointer-events-none">
                            <GripHorizontal className="w-3 h-3" />
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-[10px] font-bold text-orange-400 uppercase tracking-widest px-1">DEVICE</span>
                            <div className="flex gap-2 border-r border-orange-500/30 pr-2">
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setSelectedDevice('mobile');
                                        }}
                                        className={`p-2 rounded transition-all cursor-pointer pointer-events-auto ${
                                            selectedDevice === 'mobile'
                                                ? 'bg-blue-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Mobile (375Ã—812)"
                                        type="button"
                                    >
                                        <Smartphone className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[7px] font-black uppercase tracking-widest whitespace-nowrap ${selectedDevice === 'mobile' ? 'text-blue-300' : 'text-slate-500'}`}>MOBILE</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setSelectedDevice('tablet');
                                        }}
                                        className={`p-2 rounded transition-all cursor-pointer pointer-events-auto ${
                                            selectedDevice === 'tablet'
                                                ? 'bg-cyan-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Tablet (1024Ã—768)"
                                        type="button"
                                    >
                                        <Tablet className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[7px] font-black uppercase tracking-widest ${selectedDevice === 'tablet' ? 'text-cyan-300' : 'text-slate-500'}`}>TABLET</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setSelectedDevice('desktop');
                                        }}
                                        className={`p-2 rounded transition-all cursor-pointer pointer-events-auto ${
                                            selectedDevice === 'desktop'
                                                ? 'bg-purple-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Desktop (1920Ã—1080)"
                                        type="button"
                                    >
                                        <Monitor className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[7px] font-black uppercase tracking-widest ${selectedDevice === 'desktop' ? 'text-purple-300' : 'text-slate-500'}`}>DESKTOP</span>
                                </div>
                            </div>
                            <span className="text-[10px] font-bold text-orange-400 uppercase tracking-widest px-1">ORIENTATION</span>
                            <div className="flex gap-3">
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setEditorOrientation('portrait');
                                            if (isOrientationLocked && activePlayground) {
                                                const newLayouts = { ...activePlayground.deviceLayouts };
                                                newLayouts[selectedDevice] = {
                                                    ...newLayouts[selectedDevice],
                                                    orientationLock: 'portrait',
                                                };
                                                updatePlayground({ deviceLayouts: newLayouts });
                                            }
                                        }}
                                        className={`p-2 rounded transition-all cursor-pointer pointer-events-auto ${
                                            editorOrientation === 'portrait'
                                                ? 'bg-orange-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Preview portrait"
                                        type="button"
                                    >
                                        <Smartphone className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${editorOrientation === 'portrait' ? 'text-orange-300' : 'text-slate-500'}`}>PORTRAIT</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setEditorOrientation('landscape');
                                            if (isOrientationLocked && activePlayground) {
                                                const newLayouts = { ...activePlayground.deviceLayouts };
                                                newLayouts[selectedDevice] = {
                                                    ...newLayouts[selectedDevice],
                                                    orientationLock: 'landscape',
                                                };
                                                updatePlayground({ deviceLayouts: newLayouts });
                                            }
                                        }}
                                        className={`p-2 rounded transition-all cursor-pointer pointer-events-auto ${
                                            editorOrientation === 'landscape'
                                                ? 'bg-orange-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Preview landscape (tablet default)"
                                        type="button"
                                    >
                                        <Monitor className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${editorOrientation === 'landscape' ? 'text-orange-300' : 'text-slate-500'}`}>LAND</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            if (!activePlayground) return;
                                            const newLayouts = { ...activePlayground.deviceLayouts };
                                            if (isOrientationLocked) {
                                                newLayouts[selectedDevice] = {
                                                    ...newLayouts[selectedDevice],
                                                    orientationLock: 'none',
                                                };
                                            } else {
                                                newLayouts[selectedDevice] = {
                                                    ...newLayouts[selectedDevice],
                                                    orientationLock: editorOrientation,
                                                };
                                            }
                                            updatePlayground({ deviceLayouts: newLayouts });
                                        }}
                                        className={`p-2 rounded transition-all cursor-pointer pointer-events-auto ${
                                            isOrientationLocked
                                                ? 'bg-red-600 text-white shadow-lg ring-2 ring-red-400'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title={isOrientationLocked ? 'Unlock orientation - Device can rotate freely' : 'Lock to selected orientation - Forces chosen orientation in game'}
                                        type="button"
                                    >
                                        <Lock className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${isOrientationLocked ? 'text-red-300' : 'text-slate-500'}`}>LOCK</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Orientation Lock Warning - HIDDEN - Now shown inline in left drawer */}

                {isBackgroundLocked && (
                    <div className="absolute top-4 left-4 bg-red-900/90 border-2 border-red-500 rounded-xl p-4 text-[10px] text-red-100 uppercase font-black tracking-widest shadow-2xl max-w-xs pointer-events-auto z-50 backdrop-blur-sm">
                        ðŸ”’ BACKGROUND IS LOCKED - DRAGGING DISABLED
                    </div>
                )}

                {/* Draggable SHOW Toolbar - HIDDEN - Now in left drawer */}
                <div
                    className="hidden absolute z-[1100] pointer-events-auto touch-none"
                    style={{ left: showToolbarPos.x, top: showToolbarPos.y }}
                    onPointerDown={handleShowPointerDown}
                    onPointerMove={handleShowPointerMove}
                    onPointerUp={handleShowPointerUp}
                >
                    <div className="bg-black/40 backdrop-blur-sm border border-orange-500/30 rounded-lg shadow-2xl p-2 cursor-move group relative">
                        <div className="absolute -top-3 left-1/2 -translate-x-1/2 text-orange-400 opacity-0 group-hover:opacity-100 transition-opacity bg-black/60 rounded-full px-2 border border-orange-500/30 pointer-events-none">
                            <GripHorizontal className="w-3 h-3" />
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-[10px] font-bold text-orange-400 uppercase tracking-widest px-1">SHOW</span>
                            <div className="flex gap-3">
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            // Auto-switch to landscape if on tablet in portrait mode
                                            if (selectedDevice === 'tablet' && editorOrientation === 'portrait' && !showTaskScores) {
                                                setEditorOrientation('landscape');
                                            }
                                            setShowTaskScores(!showTaskScores);
                                        }}
                                        className={`w-9 h-9 rounded transition-all cursor-pointer pointer-events-auto flex items-center justify-center ${
                                            showTaskScores
                                                ? 'bg-orange-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Show/Hide Task Scores"
                                        type="button"
                                    >
                                        <span className="text-xs font-bold">$</span>
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${showTaskScores ? 'text-orange-300' : 'text-slate-500'}`}>SCORE</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            // Auto-switch to landscape if on tablet in portrait mode
                                            if (selectedDevice === 'tablet' && editorOrientation === 'portrait' && !showTaskOrder) {
                                                setEditorOrientation('landscape');
                                            }
                                            setShowTaskOrder(!showTaskOrder);
                                        }}
                                        className={`w-9 h-9 rounded transition-all cursor-pointer pointer-events-auto flex items-center justify-center ${
                                            showTaskOrder
                                                ? 'bg-orange-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Show/Hide Task Order Numbers"
                                        type="button"
                                    >
                                        <span className="text-xs font-bold">#</span>
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${showTaskOrder ? 'text-orange-300' : 'text-slate-500'}`}>ORDER</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            // Auto-switch to landscape if on tablet in portrait mode
                                            if (selectedDevice === 'tablet' && editorOrientation === 'portrait' && !showTaskActions) {
                                                setEditorOrientation('landscape');
                                            }
                                            setShowTaskActions(!showTaskActions);
                                        }}
                                        className={`w-9 h-9 rounded transition-all cursor-pointer pointer-events-auto flex items-center justify-center ${
                                            showTaskActions
                                                ? 'bg-orange-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Show/Hide Task Actions"
                                        type="button"
                                    >
                                        <Zap className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${showTaskActions ? 'text-orange-300' : 'text-slate-500'}`}>ACTIONS</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            // Auto-switch to landscape if on tablet in portrait mode
                                            if (selectedDevice === 'tablet' && editorOrientation === 'portrait' && !showTaskNames) {
                                                setEditorOrientation('landscape');
                                            }
                                            setShowTaskNames(!showTaskNames);
                                        }}
                                        className={`w-9 h-9 rounded transition-all cursor-pointer pointer-events-auto flex items-center justify-center ${
                                            showTaskNames
                                                ? 'bg-orange-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Show/Hide Task Names"
                                        type="button"
                                    >
                                        <Type className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${showTaskNames ? 'text-orange-300' : 'text-slate-500'}`}>NAME</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            // Auto-switch to landscape if on tablet in portrait mode
                                            if (selectedDevice === 'tablet' && editorOrientation === 'portrait' && !showTaskStatus) {
                                                setEditorOrientation('landscape');
                                            }
                                            setShowTaskStatus(!showTaskStatus);
                                        }}
                                        className={`w-9 h-9 rounded transition-all cursor-pointer pointer-events-auto flex items-center justify-center ${
                                            showTaskStatus
                                                ? 'bg-orange-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Show/Hide answer markers (âœ“ correct / âœ— wrong) in editor preview. Each task can enable/disable this in settings."
                                        type="button"
                                    >
                                        <CheckCircle className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${
                                        showTaskStatus ? 'text-orange-300' : 'text-slate-500'
                                    }`}>ANSWERS</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            // Auto-switch to landscape if on tablet in portrait mode
                                            if (selectedDevice === 'tablet' && editorOrientation === 'portrait' && !showBackground) {
                                                setEditorOrientation('landscape');
                                            }
                                            setShowBackground(!showBackground);
                                        }}
                                        className={`w-9 h-9 rounded transition-all cursor-pointer pointer-events-auto flex items-center justify-center ${
                                            showBackground
                                                ? 'bg-orange-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Show/Hide Background"
                                        type="button"
                                    >
                                        <ImageIcon className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${showBackground ? 'text-orange-300' : 'text-slate-500'}`}>BACKGROUND</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            // Auto-switch to landscape if on tablet in portrait mode
                                            if (selectedDevice === 'tablet' && editorOrientation === 'portrait' && !showQRScanner) {
                                                setEditorOrientation('landscape');
                                            }
                                            setShowQRScanner(!showQRScanner);
                                        }}
                                        className={`w-9 h-9 rounded transition-all cursor-pointer pointer-events-auto flex items-center justify-center ${
                                            showQRScanner
                                                ? 'bg-orange-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Show/Hide QR Scanner"
                                        type="button"
                                    >
                                        <QrCode className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${showQRScanner ? 'text-orange-300' : 'text-slate-500'}`}>QR</span>
                                </div>
                                <div className="flex flex-col items-center gap-0.5">
                                    <button
                                        onClick={(e) => {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            // Auto-switch to landscape if on tablet in portrait mode
                                            if (selectedDevice === 'tablet' && editorOrientation === 'portrait' && !showRanking) {
                                                setEditorOrientation('landscape');
                                            }
                                            setShowRanking(!showRanking);
                                        }}
                                        className={`w-9 h-9 rounded transition-all cursor-pointer pointer-events-auto flex items-center justify-center ${
                                            showRanking
                                                ? 'bg-orange-600 text-white shadow-lg'
                                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600 hover:text-white'
                                        }`}
                                        title="Show/Hide Ranking Leaderboard"
                                        type="button"
                                    >
                                        <Trophy className="w-4 h-4" />
                                    </button>
                                    <span className={`text-[8px] font-black uppercase tracking-widest ${showRanking ? 'text-orange-300' : 'text-slate-500'}`}>RANKING</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Draggable TOOLS Toolbar */}
                {/* TOOLS Toolbar - REMOVED */}

                {/* Canvas Area */}
                <div
                    ref={canvasRef}
                    className={`flex-1 overflow-hidden relative bg-[linear-gradient(rgba(255,255,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(255,255,255,0.03)_1px,transparent_1px)] [background-size:40px_40px] [background-position:center] flex items-center justify-center p-4 ${
                        snapToRoadMode ? 'cursor-crosshair'
                        : drawMode.active ? 'cursor-crosshair'
                        : 'cursor-grab active:cursor-grabbing'
                    }`}
                    onWheel={snapToRoadMode ? undefined : handleWheel}
                    onMouseDown={snapToRoadMode ? handleSnapToRoadStart : handleMouseDown}
                    onMouseMove={snapToRoadMode ? handleSnapToRoadMove : handleMouseMove}
                    onMouseUp={snapToRoadMode ? handleSnapToRoadEnd : handleMouseUp}
                    onMouseLeave={snapToRoadMode ? undefined : handleMouseUp}
                >
                    {/* Device Frame Scaling Wrapper - ensures full tablet portrait frame is visible */}
                    <div
                        className="flex items-center justify-center"
                        style={{
                            transform: selectedDevice === 'tablet' && editorOrientation === 'portrait' ? 'scale(0.72)' : 'scale(1)',
                            transformOrigin: 'center center',
                            transition: 'transform 0.3s ease-out',
                            width: selectedDevice === 'desktop' ? '100%' : 'auto',
                            height: selectedDevice === 'desktop' ? '100%' : 'auto'
                        }}
                    >
                        {/* Device Frame Container - Responsive to Selected Device */}
                        <div className={`relative border-8 border-slate-950 rounded-3xl overflow-hidden flex-shrink-0`}
                        style={{
                            width: viewportDims.width,
                            height: viewportDims.height,
                            boxShadow: '0 0 0 12px #1f2937, 0 0 0 16px #000000, inset 0 0 0 1px #444'
                        }}>
                        <div
                        ref={backgroundRef}
                        style={{
                            ...bgStyle,
                            width: '100%',
                            height: '100%'
                        }}
                        className="relative"
                    >
                        {!activePlayground?.imageUrl && (
                            <div className="absolute inset-0 flex items-center justify-center border-4 border-dashed border-slate-700/50 m-20 rounded-3xl">
                                <div className="text-center opacity-30">
                                    <ImageIcon className="w-24 h-24 mx-auto mb-4" />
                                    <p className="text-2xl font-black uppercase tracking-widest">UPLOAD BACKGROUND</p>
                                </div>
                            </div>
                        )}

                        {/* Grid Overlay */}
                        {showGrid && (
                            <svg
                                className="absolute inset-0 w-full h-full pointer-events-none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <defs>
                                    <pattern id="grid" width="30" height="30" patternUnits="userSpaceOnUse">
                                        <path d="M 30 0 L 0 0 0 30" fill="none" stroke="rgba(255, 165, 0, 0.6)" strokeWidth="1.5"/>
                                    </pattern>
                                </defs>
                                <rect width="100%" height="100%" fill="url(#grid)" />
                            </svg>
                        )}

                        {/* Action Links Visualization */}
                        {showTaskActions && (
                            <svg
                                className="absolute inset-0 w-full h-full pointer-events-none"
                                viewBox="0 0 100 100"
                                preserveAspectRatio="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                <defs>
                                    <pattern id="correct-dots" width="8" height="2" patternUnits="userSpaceOnUse">
                                        <circle cx="1" cy="1" r="0.5" fill="#10b981" opacity="0.8"/>
                                    </pattern>
                                    <pattern id="incorrect-dots" width="8" height="2" patternUnits="userSpaceOnUse">
                                        <circle cx="1" cy="1" r="0.5" fill="#ef4444" opacity="0.8"/>
                                    </pattern>
                                    <pattern id="action-dots" width="8" height="2" patternUnits="userSpaceOnUse">
                                        <circle cx="1" cy="1" r="0.5" fill="#eab308" opacity="0.8"/>
                                    </pattern>
                                </defs>
                                {uniquePlaygroundPoints.flatMap((source) => {
                                    const sourcePos = getDevicePosition(source);
                                    const sourceX = sourcePos.x;
                                    const sourceY = sourcePos.y;

                                    // Extract target IDs from GameAction objects
                                    const getTargetIds = (actions: any[] | undefined) => {
                                        if (!actions) return [];
                                        return actions
                                            .map(action => action.targetId || action)
                                            .filter(id => typeof id === 'string' && id.length > 0);
                                    };

                                    return [
                                        ...getTargetIds(source.logic?.onCorrect).map((targetId, idx) => {
                                            const target = game.points?.find(p => p.id === targetId);
                                            if (!target) return null;
                                            const targetPos = getDevicePosition(target);
                                            const targetX = targetPos.x;
                                            const targetY = targetPos.y;
                                            return (
                                                <line
                                                    key={`correct-${source.id}-${targetId}-${idx}`}
                                                    x1={sourceX}
                                                    y1={sourceY}
                                                    x2={targetX}
                                                    y2={targetY}
                                                    stroke="#10b981"
                                                    strokeWidth="1.2"
                                                    strokeDasharray="4,3"
                                                    opacity="0.9"
                                                    className="animate-pulse"
                                                />
                                            );
                                        }),
                                        ...getTargetIds(source.logic?.onIncorrect).map((targetId, idx) => {
                                            const target = game.points?.find(p => p.id === targetId);
                                            if (!target) return null;
                                            const targetPos = getDevicePosition(target);
                                            const targetX = targetPos.x;
                                            const targetY = targetPos.y;
                                            return (
                                                <line
                                                    key={`incorrect-${source.id}-${targetId}-${idx}`}
                                                    x1={sourceX}
                                                    y1={sourceY}
                                                    x2={targetX}
                                                    y2={targetY}
                                                    stroke="#ef4444"
                                                    strokeWidth="1.2"
                                                    strokeDasharray="4,3"
                                                    opacity="0.9"
                                                    className="animate-pulse"
                                                />
                                            );
                                        }),
                                        ...getTargetIds(source.logic?.onOpen).map((targetId, idx) => {
                                            const target = game.points?.find(p => p.id === targetId);
                                            if (!target) return null;
                                            const targetPos = getDevicePosition(target);
                                            const targetX = targetPos.x;
                                            const targetY = targetPos.y;
                                            return (
                                                <line
                                                    key={`open-${source.id}-${targetId}-${idx}`}
                                                    x1={sourceX}
                                                    y1={sourceY}
                                                    x2={targetX}
                                                    y2={targetY}
                                                    stroke="#eab308"
                                                    strokeWidth="1.2"
                                                    strokeDasharray="4,3"
                                                    opacity="0.9"
                                                    className="animate-pulse"
                                                />
                                            );
                                        })
                                    ].filter(Boolean);
                                })}
                            </svg>
                        )}

                        {/* Temporary Draw Line - Shows line from source to mouse cursor */}
                        {drawMode.active && drawMode.sourceTaskId && drawMode.mousePosition && (
                            <svg
                                className="absolute inset-0 w-full h-full pointer-events-none"
                                viewBox="0 0 100 100"
                                preserveAspectRatio="none"
                                xmlns="http://www.w3.org/2000/svg"
                            >
                                {(() => {
                                    const sourceTask = uniquePlaygroundPoints.find(p => p.id === drawMode.sourceTaskId);
                                    if (!sourceTask) return null;

                                    const sourcePos = getDevicePosition(sourceTask);
                                    const sourceX = sourcePos.x;
                                    const sourceY = sourcePos.y;
                                    const mouseX = drawMode.mousePosition.x;
                                    const mouseY = drawMode.mousePosition.y;

                                    const lineColor = drawMode.trigger === 'onCorrect'
                                        ? '#10b981'
                                        : drawMode.trigger === 'onIncorrect'
                                        ? '#ef4444'
                                        : '#eab308';

                                    return (
                                        <>
                                            {/* Animated line */}
                                            <line
                                                x1={sourceX}
                                                y1={sourceY}
                                                x2={mouseX}
                                                y2={mouseY}
                                                stroke={lineColor}
                                                strokeWidth="1.2"
                                                strokeDasharray="4,3"
                                                opacity="0.9"
                                                className="animate-pulse"
                                            />
                                            {/* End point circle */}
                                            <circle
                                                cx={mouseX}
                                                cy={mouseY}
                                                r="1.5"
                                                fill={lineColor}
                                                opacity="0.7"
                                            />
                                        </>
                                    );
                                })()}
                            </svg>
                        )}

                        {/* Tasks on Canvas */}
                        {uniquePlaygroundPoints.map((point, index) => {
                            const Icon = ICON_COMPONENTS[point.iconId] || ICON_COMPONENTS.default;
                            const isSelected = selectedTaskId === point.id;
                            const isMarked = markedTaskIds.has(point.id);
                            const displaySize = (point.playgroundScale || 1) * 48;
                            const isDraggingThis = draggingTaskId === point.id;

                            // Draw mode visual states
                            const isDrawSource = drawMode.active && drawMode.sourceTaskId === point.id;
                            const isDrawTarget = drawMode.active && drawMode.sourceTaskId && point.id !== drawMode.sourceTaskId;
                            const isHoveredTarget = isDrawTarget && hoveredTaskId === point.id;

                            // Check if this task is a target of any action from other tasks
                            const isActionTarget = uniquePlaygroundPoints.some(source =>
                                source.id !== point.id && source.logic && (
                                    (source.logic.onCorrect?.some((a: any) => a.targetId === point.id || a === point.id)) ||
                                    (source.logic.onIncorrect?.some((a: any) => a.targetId === point.id || a === point.id)) ||
                                    (source.logic.onOpen?.some((a: any) => a.targetId === point.id || a === point.id))
                                )
                            );
                            // Use visual position while dragging, otherwise use device-specific position
                            const devicePos = getDevicePosition(point);
                            const displayX = isDraggingThis && dragVisualPosition ? dragVisualPosition.x : devicePos.x;
                            const displayY = isDraggingThis && dragVisualPosition ? dragVisualPosition.y : devicePos.y;

                            return (
                                <div
                                    key={point.id}
                                    className={`absolute transform -translate-x-1/2 -translate-y-1/2 group ${
                                        isSimulationActive ? 'cursor-pointer'
                                        : isDraggingThis ? 'cursor-grabbing'
                                        : isDrawTarget ? 'cursor-pointer'
                                        : isMarkMode ? 'cursor-pointer'
                                        : drawMode.active ? 'cursor-default'
                                        : 'cursor-grab'
                                    }`}
                                    style={{ left: `${displayX}%`, top: `${displayY}%` }}
                                    onMouseDown={(e) => {
                                        e.preventDefault();
                                        e.stopPropagation();
                                    }}
                                    onMouseEnter={() => setHoveredTaskId(point.id)}
                                    onMouseLeave={() => setHoveredTaskId(null)}
                                    onPointerDown={(e) => {
                                        // SIMULATION MODE: Click task to open it
                                        if (isSimulationActive) {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            setActiveSimulationTaskId(point.id);
                                            return;
                                        }

                                        if (drawMode.active && drawMode.sourceTaskId && point.id !== drawMode.sourceTaskId) {
                                            // In draw mode: clicking a target task creates the connection
                                            e.preventDefault();
                                            e.stopPropagation();

                                            const sourceTask = uniquePlaygroundPoints.find(p => p.id === drawMode.sourceTaskId);
                                            if (sourceTask && drawMode.trigger) {
                                                // Create a new "unlock" action with this target
                                                const newAction: any = {
                                                    id: `act-${Date.now()}`,
                                                    type: 'unlock',
                                                    targetId: point.id
                                                };

                                                const updatedLogic = {
                                                    ...sourceTask.logic,
                                                    [drawMode.trigger]: [...(sourceTask.logic?.[drawMode.trigger] || []), newAction]
                                                };

                                                // Update the game with the new logic
                                                onUpdateGame({
                                                    ...game,
                                                    points: game.points.map(p =>
                                                        p.id === sourceTask.id
                                                            ? { ...p, logic: updatedLogic }
                                                            : p
                                                    )
                                                });

                                                // Keep draw mode active so user can continue connecting
                                                console.log(`Connected ${sourceTask.title} â†’ ${point.title} via ${drawMode.trigger}`);
                                            }
                                        } else if (isMarkMode && !isDraggingThis) {
                                            e.preventDefault();
                                            e.stopPropagation();
                                            toggleMarkTask(point.id);
                                        } else if (!drawMode.active) {
                                            handleTaskPointerDown(e, point);
                                        }
                                    }}
                                    onPointerMove={handleTaskPointerMove}
                                    onPointerUp={handleTaskPointerUp}
                                    onPointerCancel={handleTaskPointerUp}
                                >
                                    <div className={`rounded-full flex items-center justify-center border-4 shadow-xl transition-all relative overflow-hidden ${
                                        isDrawSource && drawMode.trigger === 'onCorrect'
                                            ? 'border-green-500 shadow-green-500/70 scale-125 animate-pulse'
                                            : isDrawSource && drawMode.trigger === 'onIncorrect'
                                            ? 'border-red-500 shadow-red-500/70 scale-125 animate-pulse'
                                            : isDrawSource && drawMode.trigger === 'onOpen'
                                            ? 'border-yellow-500 shadow-yellow-500/70 scale-125 animate-pulse'
                                            : isHoveredTarget && drawMode.trigger === 'onCorrect'
                                            ? 'border-green-400 shadow-green-400/70 scale-125 ring-4 ring-green-400/30'
                                            : isHoveredTarget && drawMode.trigger === 'onIncorrect'
                                            ? 'border-red-400 shadow-red-400/70 scale-125 ring-4 ring-red-400/30'
                                            : isHoveredTarget && drawMode.trigger === 'onOpen'
                                            ? 'border-yellow-400 shadow-yellow-400/70 scale-125 ring-4 ring-yellow-400/30'
                                            : isDrawTarget
                                            ? 'border-slate-500 opacity-60'
                                            : hoveredTaskId === point.id
                                            ? 'border-orange-400 shadow-orange-400/70 scale-125'
                                            : isMarked
                                            ? 'border-orange-400 shadow-orange-400/70 scale-120 animate-pulse'
                                            : isSelected
                                            ? 'border-orange-500 shadow-orange-500/50 scale-125'
                                            : 'border-slate-900 group-hover:scale-110'
                                    } ${point.isCompleted ? 'bg-green-500' : isActionTarget ? 'bg-slate-400/40' : 'bg-white'} ${isActionTarget && !isDrawTarget ? 'opacity-50' : ''}`}
                                    style={{ width: displaySize, height: displaySize }}>
                                        {/* Display icon based on answer status: solved icon if correct, unsolved if incorrect */}
                                        {((point.isCompleted && !((point as any).answeredIncorrectly)) && point.completedIconUrl) ? (
                                            // Correct answer - show solved icon
                                            <img
                                                src={point.completedIconUrl}
                                                alt={`${point.title} (Solved)`}
                                                className={`object-cover object-center rounded-full ${isActionTarget ? 'opacity-50' : ''}`}
                                                style={{
                                                    width: `${(point.iconImageScale || 0.9) * 100}%`,
                                                    height: `${(point.iconImageScale || 0.9) * 100}%`
                                                }}
                                            />
                                        ) : point.iconUrl ? (
                                            // Unsolved or incorrect answer - show regular icon
                                            <img
                                                src={point.iconUrl}
                                                alt={point.title}
                                                className={`object-cover object-center rounded-full ${isActionTarget ? 'opacity-50' : ''}`}
                                                style={{
                                                    width: `${(point.iconImageScale || 0.9) * 100}%`,
                                                    height: `${(point.iconImageScale || 0.9) * 100}%`
                                                }}
                                            />
                                        ) : (
                                            <Icon className={`w-6 h-6 ${point.isCompleted && !((point as any).answeredIncorrectly) ? 'text-white' : isActionTarget ? 'text-slate-400' : 'text-slate-900'}`} />
                                        )}

                                        {/* OK/Wrong Answer Marker - Green Check (correct) or Red X (wrong) */}
                                        {showTaskStatus && (point.showStatusMarkers ?? true) && (point.isCompleted || (point as any).answeredIncorrectly) && (
                                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                {(point as any).answeredIncorrectly ? (
                                                    // Red X for incorrect - fills entire icon
                                                    <XCircle className="w-full h-full text-red-500 drop-shadow-[0_4px_12px_rgba(239,68,68,0.9)]" strokeWidth={2} />
                                                ) : (
                                                    // Green checkmark for correct - fills entire icon
                                                    <CheckCircle className="w-full h-full text-green-500 drop-shadow-[0_4px_12px_rgba(34,197,94,0.9)]" strokeWidth={2} />
                                                )}
                                            </div>
                                        )}
                                    </div>

                                    {/* Badges - Positioned outside overflow-hidden container to render on top */}
                                    {/* Mark Indicator Badge */}
                                    {isMarked && (
                                        <div className="absolute -top-2 -right-2 bg-orange-400 text-white text-[10px] font-black rounded-full w-6 h-6 flex items-center justify-center border-2 border-white shadow-lg pointer-events-none">
                                            âœ“
                                        </div>
                                    )}

                                    {/* Task Order Badge */}
                                    {showTaskOrder && (
                                        <div className="absolute -top-1 -right-1 bg-orange-600 text-white text-[8px] font-black rounded-full w-5 h-5 flex items-center justify-center border-2 border-white shadow-lg pointer-events-none">
                                            {String(index + 1).padStart(2, '0')}
                                        </div>
                                    )}

                                    {/* Task Score Badge */}
                                    {showTaskScores && (
                                        <div className="absolute -bottom-1 -right-1 bg-yellow-500 text-slate-900 text-[8px] font-black rounded-full w-5 h-5 flex items-center justify-center border-2 border-white shadow-lg pointer-events-none">
                                            {point.points}
                                        </div>
                                    )}

                                    {/* Task Actions Badge */}
                                    {showTaskActions && point.logic && (point.logic.onOpen?.length || point.logic.onCorrect?.length || point.logic.onIncorrect?.length) && (
                                        <div className="absolute -bottom-1 -left-1 bg-purple-600 text-white text-[8px] font-black rounded-full w-5 h-5 flex items-center justify-center border-2 border-white shadow-lg pointer-events-none">
                                            âš¡
                                        </div>
                                    )}

                                    {/* Task Name - Always Visible when showTaskNames is true */}
                                    {showTaskNames && (
                                        <div
                                            className="absolute top-full left-1/2 -translate-x-1/2 mt-2 bg-black/90 text-white font-bold px-2 py-1 rounded uppercase whitespace-nowrap pointer-events-none shadow-lg border border-orange-500/30"
                                            style={{
                                                fontSize: `${(point.textLabelScale || 1) * 9}px`
                                            }}
                                        >
                                            {point.title}
                                        </div>
                                    )}

                                    {/* Hover Tooltip - Only visible when names are hidden OR in mark mode */}
                                    {(!showTaskNames || isMarkMode) && (
                                        <div className="absolute top-full left-1/2 -translate-x-1/2 mt-2 bg-black/80 text-white text-[9px] font-bold px-2 py-1 rounded uppercase whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                            {isMarkMode ? (isMarked ? 'âœ“ MARKED' : 'CLICK TO MARK') : point.title}
                                        </div>
                                    )}
                                </div>
                            );
                        })}

                        {/* Draggable QR Scanner Button - Inside Game Canvas */}
                        {showQRScanner && (
                            <div
                                className="absolute transform -translate-x-1/2 -translate-y-1/2 z-40 pointer-events-auto group"
                                style={{
                                    left: `${qrScannerPos.x}%`,
                                    top: `${qrScannerPos.y}%`,
                                    width: `${qrScannerSize.width}px`,
                                    height: `${qrScannerSize.height}px`,
                                }}
                                onPointerDown={isSimulationActive ? undefined : handleQRScannerPointerDown}
                                onPointerMove={isSimulationActive ? undefined : handleQRScannerPointerMove}
                                onPointerUp={isSimulationActive ? undefined : handleQRScannerPointerUp}
                                onPointerCancel={isSimulationActive ? undefined : handleQRScannerPointerUp}
                            >
                                {/* QR Scan Button - Resizable, draggable, color customizable */}
                                <button
                                    onPointerDown={(e) => {
                                        e.stopPropagation();
                                        // Track button position for click detection (separate from wrapper's drag)
                                        qrScannerButtonDownPos.current = { x: e.clientX, y: e.clientY };
                                        qrScannerHasMoved.current = false;
                                    }}
                                    onPointerMove={(e) => {
                                        // Track if user moved significantly (threshold: 5px)
                                        const deltaX = Math.abs(e.clientX - qrScannerButtonDownPos.current.x);
                                        const deltaY = Math.abs(e.clientY - qrScannerButtonDownPos.current.y);
                                        if (deltaX > 5 || deltaY > 5) {
                                            qrScannerHasMoved.current = true;
                                        }
                                    }}
                                    onPointerUp={(e) => {
                                        e.stopPropagation();

                                        // Only count as click if there was minimal movement
                                        if (qrScannerHasMoved.current) {
                                            return; // This was a drag, not a click
                                        }

                                        // In simulation mode, always open scanner on single click
                                        if (isSimulationActive) {
                                            handleQRScanClick();
                                            return;
                                        }

                                        // In editor mode, detect double-click for color picker
                                        qrScannerClickCount.current++;

                                        if (qrScannerClickCount.current === 1) {
                                            // First click - set timer to detect double-click
                                            if (qrScannerClickTimer.current) {
                                                clearTimeout(qrScannerClickTimer.current);
                                            }
                                            qrScannerClickTimer.current = setTimeout(() => {
                                                // Single click - do nothing, just allow drag/resize
                                                qrScannerClickCount.current = 0;
                                            }, 300);
                                        } else if (qrScannerClickCount.current === 2) {
                                            // Double-click detected - open color picker
                                            if (qrScannerClickTimer.current) {
                                                clearTimeout(qrScannerClickTimer.current);
                                            }
                                            qrScannerClickCount.current = 0;
                                            handleQRScanClick(); // Opens color picker
                                        }
                                    }}
                                    style={{
                                        backgroundColor: qrScannerColor,
                                        width: '100%',
                                        height: '100%',
                                        boxShadow: `inset 0 0 0 2px rgba(0, 0, 0, 0.8), 0 0 8px rgba(0, 0, 0, 0.9), 0 0 16px rgba(0, 0, 0, 0.7)`
                                    }}
                                    className={`flex items-center justify-center gap-1 rounded-xl text-white font-bold uppercase shadow-xl transition-all hover:ring-2 hover:ring-yellow-400 relative ${
                                        isSimulationActive ? 'cursor-pointer' : 'cursor-move'
                                    }`}
                                    title={isSimulationActive ? 'Click to scan QR code' : 'Double-click to change color | Drag to move | Resize from corner'}
                                    type="button"
                                >
                                    {(() => {
                                        // Scale icon and text proportionally based on button height
                                        const baseHeight = 48;
                                        const scale = qrScannerSize.height / baseHeight;
                                        const iconSize = Math.max(12, Math.min(32, 16 * scale));
                                        const fontSize = Math.max(8, Math.min(14, 10 * scale));

                                        return (
                                            <>
                                                <QrCode style={{ width: `${iconSize}px`, height: `${iconSize}px` }} />
                                                <span style={{ fontSize: `${fontSize}px` }}>
                                                    SCAN QR
                                                </span>
                                            </>
                                        );
                                    })()}
                                </button>

                                {/* Resize handle - bottom-right corner (hidden in simulation mode) */}
                                {!isSimulationActive && (
                                    <div
                                        className="qr-resize-handle absolute bottom-0 right-0 w-4 h-4 bg-yellow-400 border-2 border-yellow-600 rounded-tl rounded-br cursor-nwse-resize opacity-0 group-hover:opacity-100 transition-opacity"
                                        onPointerDown={handleQRScannerResizeDown}
                                        onPointerMove={handleQRScannerResizeMove}
                                        onPointerUp={handleQRScannerResizeUp}
                                        onPointerCancel={handleQRScannerResizeUp}
                                        title="Drag to resize"
                                        onClick={(e) => e.stopPropagation()}
                                    />
                                )}
                            </div>
                        )}
                        </div>
                    </div>
                    </div>
                </div>

                {/* Right Side Tools hidden - functionality moved to right tasks drawer */}

                {/* Delete Zone - Bottom Right */}
                {/* Zoom Controls & Tools - Bottom Center */}
                <div className="absolute bottom-6 left-1/2 -translate-x-1/2 z-20 flex gap-2 pointer-events-auto">
                    <button
                        onClick={() => setZoom(z => Math.max(0.2, z - 0.1))}
                        className="p-3 bg-slate-900 hover:bg-slate-800 text-white rounded-full shadow-xl border border-slate-700 transition-colors"
                        title="Zoom Out"
                    >
                        <ZoomOut className="w-5 h-5" />
                    </button>

                    {/* CENTER Button */}
                    <button
                        onClick={handleCenterBackground}
                        className="p-3 bg-slate-900 hover:bg-slate-800 text-white rounded-full shadow-xl border border-slate-700 transition-colors"
                        title="Center Background"
                    >
                        <Target className="w-5 h-5" />
                    </button>

                    {/* LOCK Background Button */}
                    <button
                        onClick={() => setIsBackgroundLocked(!isBackgroundLocked)}
                        className={`p-3 rounded-full shadow-xl border-2 transition-colors ${
                            isBackgroundLocked
                                ? 'bg-red-600 border-red-500 text-white hover:bg-red-700'
                                : 'bg-slate-900 border-slate-700 text-white hover:bg-slate-800'
                        }`}
                        title={isBackgroundLocked ? 'Unlock background (draggable)' : 'Lock background (not draggable)'}
                    >
                        {isBackgroundLocked ? <Lock className="w-5 h-5" /> : <Unlock className="w-5 h-5" />}
                    </button>

                    <button
                        onClick={() => setZoom(z => Math.min(5, z + 0.1))}
                        className="p-3 bg-slate-900 hover:bg-slate-800 text-white rounded-full shadow-xl border border-slate-700 transition-colors"
                        title="Zoom In"
                    >
                        <ZoomIn className="w-5 h-5" />
                    </button>
                </div>

                {/* Delete Zone (BIN) - Bottom Right Corner */}
                <button
                    id="delete-zone-btn"
                    className={`absolute bottom-6 right-6 z-20 p-4 rounded-full shadow-xl border-2 transition-all pointer-events-auto ${
                        isOverDeleteZone
                            ? 'bg-red-600 border-red-500 text-white scale-110 animate-pulse shadow-red-500/50'
                            : 'bg-slate-900 border-slate-700 text-slate-400 hover:text-red-500 hover:border-red-600 hover:bg-slate-800'
                    }`}
                    title={isOverDeleteZone ? 'Drop to delete task' : 'Drag task here to delete from map'}
                >
                    <Trash2 className="w-5 h-5" />
                </button>

                {/* Snap-to-Road Selection Box Visualization */}
                {snapToRoadMode && selectionBox.start && selectionBox.current && (
                    <div
                        className="absolute border-2 border-cyan-500 bg-cyan-500/10 pointer-events-none z-40"
                        style={{
                            left: `${Math.min(selectionBox.start.x, selectionBox.current.x)}px`,
                            top: `${Math.min(selectionBox.start.y, selectionBox.current.y)}px`,
                            width: `${Math.abs(selectionBox.current.x - selectionBox.start.x)}px`,
                            height: `${Math.abs(selectionBox.current.y - selectionBox.start.y)}px`,
                            boxShadow: '0 0 8px rgba(34, 211, 238, 0.5)'
                        }}
                    />
                )}

                {/* Right Tasks Drawer Toggle Button - Always Visible */}
                <button
                    onClick={() => setIsTasksDrawerOpen(!isTasksDrawerOpen)}
                    className="absolute right-0 top-1/2 -translate-y-1/2 z-30 bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-l-2xl shadow-2xl transition-all active:scale-95"
                    title={isTasksDrawerOpen ? "Close Tasks" : "Open Tasks"}
                >
                    {isTasksDrawerOpen ? <ChevronRight className="w-6 h-6" /> : <ChevronLeft className="w-6 h-6" />}
                </button>
            </div>

            {/* RIGHT SIDE TASKS DRAWER - COLLAPSIBLE */}
            <div className={`flex flex-col border-l border-slate-800 bg-[#0f172a] shadow-2xl z-20 transition-all duration-300 ease-in-out ${
                isTasksDrawerOpen ? 'w-[360px]' : 'w-0'
            } overflow-hidden`}>
                {/* Header */}
                <div className="p-3 border-b border-slate-800 bg-[#0f172a] relative">
                    <button
                        onClick={() => setIsTasksDrawerOpen(false)}
                        className="absolute left-5 top-1/2 -translate-y-1/2 text-orange-500 hover:text-orange-400 transition-colors p-2"
                        title="Close Tasks"
                    >
                        <ChevronRight className="w-6 h-6" />
                    </button>
                    <div className="flex flex-col items-center gap-2">
                        <h2 className="text-sm font-black uppercase tracking-widest text-white">TASKS</h2>
                        <p className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">{uniquePlaygroundPoints.length} in zone</p>
                    </div>
                </div>

                {/* Content - Task Creation or Task Editor */}
                <div className="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
                    {selectedTask ? (
                        // Task Editor Panel
                        <div className="space-y-4">
                            {/* Back Button */}
                            <button
                                onClick={() => setSelectedTaskId(null)}
                                className="w-full py-2 flex items-center justify-center gap-2 text-slate-400 hover:text-white transition-colors text-[10px] font-bold uppercase tracking-widest"
                            >
                                <ArrowLeft className="w-4 h-4" /> BACK TO LIST
                            </button>

                            {/* Task Title */}
                            <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-3 space-y-3">
                                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">TASK TITLE</label>
                                <input
                                    value={selectedTask.title}
                                    onChange={(e) => updateTask({ title: e.target.value })}
                                    className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm font-bold text-white outline-none focus:border-orange-500"
                                />

                                {/* Task Action Buttons */}
                                <div className="grid grid-cols-3 gap-2 pt-2 border-t border-slate-700">
                                    {/* SETTINGS Button (Orange) */}
                                    <button
                                        onClick={() => {
                                            setSettingsModalTaskId(selectedTask.id);
                                            setShowTaskSettingsModal(true);
                                        }}
                                        className="py-2 bg-orange-600/20 hover:bg-orange-600/40 text-orange-400 hover:text-orange-300 border border-orange-600/40 hover:border-orange-500 rounded-lg font-bold uppercase tracking-wider text-[9px] flex flex-col items-center justify-center gap-1 transition-all"
                                        title="Open task settings"
                                    >
                                        <Settings className="w-4 h-4" />
                                        <span>SETTINGS</span>
                                    </button>

                                    {/* ACTIONS Button (Green) */}
                                    <button
                                        onClick={() => setShowActionModal(true)}
                                        className="py-2 bg-green-600/20 hover:bg-green-600/40 text-green-400 hover:text-green-300 border border-green-600/40 hover:border-green-500 rounded-lg font-bold uppercase tracking-wider text-[9px] flex flex-col items-center justify-center gap-1 transition-all"
                                        title="Set up if/then logic and actions"
                                    >
                                        <Zap className="w-4 h-4" />
                                        <span>ACTIONS</span>
                                    </button>

                                    {/* VIEW Button (Blue) */}
                                    <button
                                        onClick={() => setShowTaskViewModal(true)}
                                        className="py-2 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 hover:text-blue-300 border border-blue-600/40 hover:border-blue-500 rounded-lg font-bold uppercase tracking-wider text-[9px] flex flex-col items-center justify-center gap-1 transition-all"
                                        title="Preview task view"
                                    >
                                        <Eye className="w-4 h-4" />
                                        <span>VIEW</span>
                                    </button>
                                </div>
                            </div>

                            {/* Task Answer Markers - Per-Task Setting */}
                            <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-3 space-y-3">
                                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-1">
                                    <CheckCircle className="w-3 h-3" /> ANSWER MARKERS IN GAMEPLAY
                                </label>
                                <p className="text-[8px] text-slate-400">
                                    When enabled, this task will show âœ“ OK or âœ— WRONG markers when teams re-enter the playzone after solving it. Toggle visibility in editor using SHOW toolbar â†’ ANSWERS button.
                                </p>
                                <button
                                    onClick={() => updateTask({ showStatusMarkers: !(selectedTask.showStatusMarkers ?? true) })}
                                    className={`w-full py-2 px-3 rounded-lg text-[10px] font-bold uppercase tracking-wide transition-all border-2 flex items-center justify-center gap-2 ${
                                        (selectedTask.showStatusMarkers ?? true)
                                            ? 'bg-green-600/30 border-green-500 text-green-300 hover:bg-green-600/40'
                                            : 'bg-slate-700 border-slate-600 text-slate-400 hover:bg-slate-600'
                                    }`}
                                >
                                    <CheckCircle className="w-4 h-4" />
                                    <span>{(selectedTask.showStatusMarkers ?? true) ? 'ENABLED' : 'DISABLED'}</span>
                                </button>
                            </div>

                            {/* Icon Size Slider */}
                            <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-3 space-y-2">
                                <div className="flex justify-between items-center">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-1">
                                        <ChevronRight className="w-3 h-3" /> ICON SIZE
                                    </label>
                                    <span className="text-[10px] font-bold text-orange-400">{Math.round((selectedTask.playgroundScale || 1) * 100)}%</span>
                                </div>
                                <input
                                    type="range"
                                    min="0.5"
                                    max="2"
                                    step="0.1"
                                    value={selectedTask.playgroundScale || 1}
                                    onChange={(e) => updateTask({ playgroundScale: parseFloat(e.target.value) })}
                                    className="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-orange-500"
                                />
                            </div>

                            {/* Text Label Size Slider - NEW */}
                            <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-3 space-y-2">
                                <div className="flex justify-between items-center">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-1">
                                        <Type className="w-3 h-3" /> TEXT LABEL SIZE
                                    </label>
                                    <span className="text-[10px] font-bold text-cyan-400">{Math.round((selectedTask.textLabelScale || 1) * 100)}%</span>
                                </div>
                                <p className="text-[8px] text-slate-400">
                                    Adjust text label size to prevent overlapping in Portrait mode
                                </p>
                                <input
                                    type="range"
                                    min="0.5"
                                    max="2"
                                    step="0.1"
                                    value={selectedTask.textLabelScale || 1}
                                    onChange={(e) => updateTask({ textLabelScale: parseFloat(e.target.value) })}
                                    className="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-cyan-500"
                                />

                                {/* Bulk Apply to Marked Tasks */}
                                {markedTaskIds.size > 0 && (
                                    <div className="pt-2 border-t border-slate-700 space-y-2">
                                        <div className="flex items-center gap-2">
                                            <div className="flex-1">
                                                <p className="text-[8px] text-orange-400 font-bold uppercase tracking-wider">
                                                    {markedTaskIds.size} {markedTaskIds.size === 1 ? 'task' : 'tasks'} marked
                                                </p>
                                                <p className="text-[7px] text-slate-500 mt-0.5">
                                                    Apply current size to all selected
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    const currentScale = selectedTask.textLabelScale || 1;
                                                    const updatedPoints = game.points.map(p =>
                                                        markedTaskIds.has(p.id) ? { ...p, textLabelScale: currentScale } : p
                                                    );
                                                    onUpdateGame({ ...game, points: updatedPoints });
                                                    alert(`Applied ${Math.round(currentScale * 100)}% text size to ${markedTaskIds.size} task(s)`);
                                                }}
                                                className="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg text-[9px] font-black uppercase tracking-wider transition-colors flex items-center gap-1 shadow-lg"
                                                title={`Apply ${Math.round((selectedTask.textLabelScale || 1) * 100)}% to ${markedTaskIds.size} selected task(s)`}
                                            >
                                                <Check className="w-3 h-3" />
                                                APPLY
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Icon Image Size Slider - NEW */}
                            <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-3 space-y-2">
                                <div className="flex justify-between items-center">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest flex items-center gap-1">
                                        <ImageIcon className="w-3 h-3" /> ICON IMAGE SIZE
                                    </label>
                                    <span className="text-[10px] font-bold text-purple-400">{Math.round((selectedTask.iconImageScale || 0.9) * 100)}%</span>
                                </div>
                                <p className="text-[8px] text-slate-400">
                                    Zoom & center picture from 50% to 200% (crops to stay within circles)
                                </p>
                                <input
                                    type="range"
                                    min="0.5"
                                    max="2.0"
                                    step="0.05"
                                    value={selectedTask.iconImageScale || 0.9}
                                    onChange={(e) => updateTask({ iconImageScale: parseFloat(e.target.value) })}
                                    className="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-purple-500"
                                />

                                {/* Bulk Apply to Marked Tasks */}
                                {markedTaskIds.size > 0 && (
                                    <div className="pt-2 border-t border-slate-700 space-y-2">
                                        <div className="flex items-center gap-2">
                                            <div className="flex-1">
                                                <p className="text-[8px] text-orange-400 font-bold uppercase tracking-wider">
                                                    {markedTaskIds.size} {markedTaskIds.size === 1 ? 'task' : 'tasks'} marked
                                                </p>
                                                <p className="text-[7px] text-slate-500 mt-0.5">
                                                    Apply current image size to all selected
                                                </p>
                                            </div>
                                            <button
                                                onClick={() => {
                                                    const currentScale = selectedTask.iconImageScale || 0.9;
                                                    const updatedPoints = game.points.map(p =>
                                                        markedTaskIds.has(p.id) ? { ...p, iconImageScale: currentScale } : p
                                                    );
                                                    onUpdateGame({ ...game, points: updatedPoints });
                                                    alert(`Applied ${Math.round(currentScale * 100)}% image size to ${markedTaskIds.size} task(s)`);
                                                }}
                                                className="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-[9px] font-black uppercase tracking-wider transition-colors flex items-center gap-1 shadow-lg"
                                                title={`Apply ${Math.round((selectedTask.iconImageScale || 0.9) * 100)}% to ${markedTaskIds.size} selected task(s)`}
                                            >
                                                <Check className="w-3 h-3" />
                                                APPLY
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Icon Editor - Dual State */}
                            <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-3 space-y-3">
                                {/* INCORRECT ANSWER ICON Section */}
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-red-400 uppercase tracking-widest">âŒ INCORRECT ANSWER</label>

                                    {/* Current Icon Preview */}
                                    {selectedTask.iconUrl && (
                                        <div className="p-3 bg-slate-700 rounded-lg flex items-center justify-between mb-2">
                                            <div className="flex items-center gap-3">
                                                <img src={selectedTask.iconUrl} alt="Incorrect Answer Icon" className="w-8 h-8 object-contain" />
                                                <span className="text-[10px] font-bold text-slate-300 uppercase tracking-wide">CUSTOM ICON</span>
                                            </div>
                                            <button
                                                onClick={() => updateTask({ iconUrl: undefined, iconId: 'default' })}
                                                className="p-1.5 text-slate-500 hover:text-red-500 transition-colors"
                                            >
                                                <X className="w-4 h-4" />
                                            </button>
                                        </div>
                                    )}

                                    {/* Icon Buttons */}
                                    <div className="grid grid-cols-3 gap-2">
                                        <button
                                            onClick={() => {
                                                setEditingCompletedIcon(false);
                                                taskIconInputRef.current?.click();
                                            }}
                                            className="py-2 px-3 border border-dashed border-slate-600 rounded-lg text-[10px] font-bold text-slate-400 hover:text-white hover:border-slate-400 transition-colors flex items-center justify-center gap-1"
                                            title="Upload custom icon for incorrect answer"
                                        >
                                            <Upload className="w-3 h-3" /> UPLOAD
                                        </button>
                                        <input ref={taskIconInputRef} type="file" className="hidden" accept="image/*" onChange={handleTaskIconUpload} />

                                        <button
                                            onClick={() => {
                                                setEditingCompletedIcon(false);
                                                setLogoCompanyName('');
                                                setShowLogoPrompt(true);
                                            }}
                                            disabled={isSearchingLogo && !editingCompletedIcon}
                                            className={`py-2 px-3 rounded-lg text-[10px] font-bold uppercase flex items-center justify-center gap-1 transition-all ${
                                                isSearchingLogo && !editingCompletedIcon
                                                    ? 'bg-blue-600/50 text-blue-300 cursor-wait'
                                                    : 'border border-dashed border-blue-600 text-blue-400 hover:text-blue-300 hover:border-blue-400'
                                            }`}
                                            title="Search for company logo online"
                                            type="button"
                                        >
                                            {isSearchingLogo && !editingCompletedIcon ? (
                                                <>
                                                    <div className="w-3 h-3 border-2 border-blue-300 border-t-transparent rounded-full animate-spin" />
                                                    <span className="text-[9px]">SEARCHING...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <Globe className="w-3 h-3" /> LOGO
                                                </>
                                            )}
                                        </button>

                                        <button
                                            onClick={() => {
                                                setEditingCompletedIcon(false);
                                                setAiIconPromptValue('');
                                                setShowAiIconPrompt(true);
                                            }}
                                            disabled={isGeneratingIcon && !editingCompletedIcon}
                                            className={`py-2 px-3 rounded-lg text-[10px] font-bold uppercase flex items-center justify-center gap-1 transition-all ${
                                                isGeneratingIcon && !editingCompletedIcon
                                                    ? 'bg-purple-600/50 text-purple-300 cursor-wait'
                                                    : 'border border-dashed border-purple-600 text-purple-400 hover:text-purple-300 hover:border-purple-400'
                                            }`}
                                            title="Generate icon with AI for incorrect answer"
                                            type="button"
                                        >
                                            {isGeneratingIcon && !editingCompletedIcon ? (
                                                <>
                                                    <div className="w-3 h-3 border-2 border-purple-300 border-t-transparent rounded-full animate-spin" />
                                                    <span className="text-[9px]">GENERATING...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <Wand2 className="w-3 h-3" /> AI ICON
                                                </>
                                            )}
                                        </button>
                                    </div>
                                </div>

                                {/* Divider */}
                                <div className="h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent"></div>

                                {/* CORRECT ANSWER ICON Section */}
                                <div className="space-y-2">
                                    <label className="text-[10px] font-black text-green-400 uppercase tracking-widest">âœ… CORRECT ANSWER</label>

                                    {/* Current Completed Icon Preview */}
                                    {selectedTask.completedIconUrl && (
                                        <div className="p-3 bg-slate-700 rounded-lg flex items-center justify-between mb-2">
                                            <div className="flex items-center gap-3">
                                                <img src={selectedTask.completedIconUrl} alt="Correct Answer Icon" className="w-8 h-8 object-contain" />
                                                <span className="text-[10px] font-bold text-slate-300 uppercase tracking-wide">CUSTOM ICON</span>
                                            </div>
                                            <button
                                                onClick={() => updateTask({ completedIconUrl: undefined, completedIconId: 'default' })}
                                                className="p-1.5 text-slate-500 hover:text-red-500 transition-colors"
                                            >
                                                <X className="w-4 h-4" />
                                            </button>
                                        </div>
                                    )}

                                    {/* Icon Buttons */}
                                    <div className="grid grid-cols-3 gap-2">
                                        <button
                                            onClick={() => {
                                                setEditingCompletedIcon(true);
                                                completedTaskIconInputRef.current?.click();
                                            }}
                                            className="py-2 px-3 border border-dashed border-slate-600 rounded-lg text-[10px] font-bold text-slate-400 hover:text-white hover:border-slate-400 transition-colors flex items-center justify-center gap-1"
                                            title="Upload custom icon for correct answer"
                                        >
                                            <Upload className="w-3 h-3" /> UPLOAD
                                        </button>
                                        <input ref={completedTaskIconInputRef} type="file" className="hidden" accept="image/*" onChange={handleCompletedTaskIconUpload} />

                                        <button
                                            onClick={() => {
                                                setEditingCompletedIcon(true);
                                                setLogoCompanyName('');
                                                setShowLogoPrompt(true);
                                            }}
                                            disabled={isSearchingLogo && editingCompletedIcon}
                                            className={`py-2 px-3 rounded-lg text-[10px] font-bold uppercase flex items-center justify-center gap-1 transition-all ${
                                                isSearchingLogo && editingCompletedIcon
                                                    ? 'bg-blue-600/50 text-blue-300 cursor-wait'
                                                    : 'border border-dashed border-blue-600 text-blue-400 hover:text-blue-300 hover:border-blue-400'
                                            }`}
                                            title="Search for company logo online"
                                            type="button"
                                        >
                                            {isSearchingLogo && editingCompletedIcon ? (
                                                <>
                                                    <div className="w-3 h-3 border-2 border-blue-300 border-t-transparent rounded-full animate-spin" />
                                                    <span className="text-[9px]">SEARCHING...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <Globe className="w-3 h-3" /> LOGO
                                                </>
                                            )}
                                        </button>

                                        <button
                                            onClick={() => {
                                                setEditingCompletedIcon(true);
                                                setAiIconPromptValue('');
                                                setShowAiIconPrompt(true);
                                            }}
                                            disabled={isGeneratingIcon && editingCompletedIcon}
                                            className={`py-2 px-3 rounded-lg text-[10px] font-bold uppercase flex items-center justify-center gap-1 transition-all ${
                                                isGeneratingIcon && editingCompletedIcon
                                                    ? 'bg-purple-600/50 text-purple-300 cursor-wait'
                                                    : 'border border-dashed border-purple-600 text-purple-400 hover:text-purple-300 hover:border-purple-400'
                                            }`}
                                            title="Generate icon with AI for correct answer"
                                            type="button"
                                        >
                                            {isGeneratingIcon && editingCompletedIcon ? (
                                                <>
                                                    <div className="w-3 h-3 border-2 border-purple-300 border-t-transparent rounded-full animate-spin" />
                                                    <span className="text-[9px]">GENERATING...</span>
                                                </>
                                            ) : (
                                                <>
                                                    <Wand2 className="w-3 h-3" /> AI ICON
                                                </>
                                            )}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Copy Task Button */}
                            <button
                                onClick={() => {
                                    const now = Date.now();
                                    const nextOrder = Math.max(0, ...game.points.map(p => (typeof p.order === 'number' ? p.order : 0))) + 1;

                                    const originalPos = getDevicePosition(selectedTask);
                                    const copiedPos = {
                                        x: Math.min(98, Math.round((originalPos.x + 2) * 10) / 10),
                                        y: Math.min(98, Math.round((originalPos.y + 2) * 10) / 10)
                                    };

                                    // Create a copy of the selected task with a new ID
                                    const newTask: GamePoint = {
                                        ...selectedTask,
                                        id: `task-${now}-${Math.random().toString(36).slice(2, 8)}`,
                                        title: `Copy of ${selectedTask.title}`,
                                        order: nextOrder,
                                        isCompleted: false,
                                        isUnlocked: true,
                                        devicePositions: {
                                            [selectedDevice]: copiedPos
                                        }
                                    };

                                    onUpdateGame({
                                        ...game,
                                        points: [...game.points, newTask]
                                    });

                                    // Save to library - create a template from the copied task
                                    (async () => {
                                        const taskTemplate: TaskTemplate = {
                                            id: `template-${Date.now()}`,
                                            title: newTask.title,
                                            task: newTask.task,
                                            feedback: newTask.feedback,
                                            points: newTask.points,
                                            tags: newTask.tags,
                                            iconId: newTask.iconId,
                                            iconUrl: newTask.iconUrl,
                                            settings: newTask.settings,
                                            logic: newTask.logic
                                        };
                                        const { ok } = await db.saveTemplates([taskTemplate]);
                                        if (!ok) {
                                            console.error('[PlaygroundEditor] Failed to save copied task to library');
                                        } else {
                                            console.log('[PlaygroundEditor] Copied task saved to library');
                                        }
                                    })();

                                    setSelectedTaskId(newTask.id);
                                }}
                                className="w-full py-3 bg-green-600/20 hover:bg-green-600/40 text-green-400 hover:text-green-300 border border-green-600/40 hover:border-green-500 rounded-lg font-bold uppercase tracking-widest text-[10px] flex items-center justify-center gap-2 transition-all"
                                title="Create a copy of this task in the current game"
                                type="button"
                            >
                                <Copy className="w-4 h-4" /> COPY TASK
                            </button>

                            {/* Delete Task Button */}
                            <button
                                onClick={() => {
                                    if (window.confirm(`Delete task "${selectedTask.title}"?`)) {
                                        onUpdateGame({
                                            ...game,
                                            points: game.points.filter(p => p.id !== selectedTask.id)
                                        });
                                        setSelectedTaskId(null);
                                    }
                                }}
                                className="w-full py-3 bg-red-600/20 hover:bg-red-600/40 text-red-400 hover:text-red-300 border border-red-600/40 hover:border-red-500 rounded-lg font-bold uppercase tracking-widest text-[10px] flex items-center justify-center gap-2 transition-all"
                            >
                                <Trash2 className="w-4 h-4" /> DELETE TASK
                            </button>
                        </div>
                    ) : (
                        <>
                            {/* Four Task Creation Buttons */}
                            <div className="grid grid-cols-2 gap-2">
                                {/* Add from Library Button */}
                                <button
                                    onClick={() => {
                                        setTaskMasterTab('LIBRARY');
                                        setShowTaskMaster(true);
                                    }}
                                    className="py-4 px-3 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 hover:text-blue-300 border border-blue-600/40 hover:border-blue-500 rounded-lg font-bold uppercase tracking-widest text-[9px] flex items-center justify-center gap-2 transition-all group flex-col"
                                    title="Add tasks from your library"
                                >
                                    <Library className="w-5 h-5 group-hover:scale-110 transition-transform" />
                                    <span>LIBRARY</span>
                                </button>

                                {/* Add AI Task Button */}
                                <button
                                    onClick={() => setShowAiTaskGenerator(true)}
                                    className="py-4 px-3 bg-purple-600/20 hover:bg-purple-600/40 text-purple-400 hover:text-purple-300 border border-purple-600/40 hover:border-purple-500 rounded-lg font-bold uppercase tracking-widest text-[9px] flex items-center justify-center gap-2 transition-all group flex-col"
                                    title="Generate tasks using the advanced AI generator"
                                >
                                    <Wand2 className="w-5 h-5 group-hover:scale-110 transition-transform" />
                                    <span>AI TASK</span>
                                </button>

                                {/* Add Tasklist Button */}
                                <button
                                    onClick={() => {
                                        setTaskMasterTab('LISTS');
                                        setShowTaskMaster(true);
                                    }}
                                    className="py-4 px-3 bg-indigo-600/20 hover:bg-indigo-600/40 text-indigo-400 hover:text-indigo-300 border border-indigo-600/40 hover:border-indigo-500 rounded-lg font-bold uppercase tracking-widest text-[9px] flex items-center justify-center gap-2 transition-all group flex-col"
                                    title="Add a tasklist with multiple items"
                                >
                                    <LayoutGrid className="w-5 h-5 group-hover:scale-110 transition-transform" />
                                    <span>TASKLIST</span>
                                </button>

                                {/* Add New Task Button */}
                                <button
                                    onClick={() => onAddTask('MANUAL', activePlayground.id)}
                                    className="py-4 px-3 bg-yellow-600/20 hover:bg-yellow-600/40 text-yellow-400 hover:text-yellow-300 border border-yellow-600/40 hover:border-yellow-500 rounded-lg font-bold uppercase tracking-widest text-[9px] flex items-center justify-center gap-2 transition-all group flex-col"
                                    title="Create a new task"
                                >
                                    <Plus className="w-5 h-5 group-hover:scale-110 transition-transform" />
                                    <span>NEW TASK</span>
                                </button>
                            </div>

                            {/* Export to Library Button */}
                            {onExportGameToLibrary && (
                                <button
                                    onClick={onExportGameToLibrary}
                                    className="w-full py-3 bg-orange-600/20 hover:bg-orange-600/40 text-orange-400 hover:text-orange-300 border border-orange-600/40 hover:border-orange-500 rounded-lg font-bold uppercase tracking-widest text-[9px] flex items-center justify-center gap-2 transition-all"
                                    title="Export all tasks to Global Library and sync to Supabase"
                                >
                                    <Download className="w-4 h-4" /> EXPORT TO LIBRARY
                                </button>
                            )}

                            {/* Divider */}
                            <div className="h-px bg-gradient-to-r from-transparent via-slate-700 to-transparent my-4"></div>

                            {/* Bulk Icon Mode Controls */}
                            {!selectedTask && (
                                <div className="bg-slate-800/50 border border-slate-700 rounded-lg p-3 space-y-2">
                                    {bulkIconMode ? (
                                        <>
                                            <div className="flex items-center justify-between mb-2">
                                                <span className="text-[10px] font-black text-orange-400 uppercase tracking-widest flex items-center gap-1">
                                                    <ImageIcon className="w-3 h-3" /> BULK ICON
                                                </span>
                                                <button
                                                    onClick={() => {
                                                        setBulkIconMode(false);
                                                        setBulkIconSourceId(null);
                                                        setBulkIconTargets(new Set());
                                                    }}
                                                    className="text-slate-500 hover:text-white text-[9px] font-bold uppercase"
                                                >
                                                    CANCEL
                                                </button>
                                            </div>
                                            <div className="space-y-2">
                                                {!bulkIconSourceId && (
                                                    <div className="p-2 bg-blue-900/30 rounded border border-blue-500/50 text-[9px] text-blue-300 font-bold uppercase">
                                                        â‘  Click a task to select as source
                                                    </div>
                                                )}
                                                {bulkIconSourceId && bulkIconTargets.size === 0 && (
                                                    <div className="p-2 bg-orange-900/30 rounded border border-orange-500/50 text-[9px] text-orange-300 font-bold uppercase">
                                                        â‘¡ Select target task(s) below
                                                    </div>
                                                )}
                                                {bulkIconSourceId && bulkIconTargets.size > 0 && (
                                                    <div className="p-2 bg-orange-900/30 rounded border border-orange-500/30 text-[9px] text-orange-300 font-bold uppercase">
                                                        {bulkIconTargets.size} target(s) selected
                                                    </div>
                                                )}
                                                {bulkIconTargets.size > 0 && (
                                                    <button
                                                        onClick={applyBulkIcon}
                                                        className="w-full py-2 bg-gradient-to-r from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white text-[10px] font-bold uppercase rounded transition-colors shadow-lg"
                                                    >
                                                        âœ“ APPLY ICON TO {bulkIconTargets.size}
                                                    </button>
                                                )}
                                                <button
                                                    onClick={() => {
                                                        setBulkIconMode(false);
                                                        setBulkIconSourceId(null);
                                                        setBulkIconTargets(new Set());
                                                    }}
                                                    className="w-full py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-slate-200 text-[9px] font-bold uppercase rounded transition-colors"
                                                >
                                                    Cancel
                                                </button>
                                            </div>
                                        </>
                                    ) : (
                                        <button
                                            onClick={() => setBulkIconMode(true)}
                                            className="w-full py-2 bg-gradient-to-r from-slate-700 to-slate-600 hover:from-slate-600 hover:to-slate-500 text-slate-300 hover:text-white text-[10px] font-bold uppercase rounded transition-colors flex items-center justify-center gap-2"
                                        >
                                            <ImageIcon className="w-3 h-3" /> COPY ICON TO MULTIPLE
                                        </button>
                                    )}
                                </div>
                            )}

                            {/* Task Sort Control */}
                            <div className="mb-3 flex items-center gap-2">
                                <label className="text-[9px] font-bold text-slate-400 uppercase tracking-wider">Sort By:</label>
                                <div className="flex gap-1">
                                    <button
                                        onClick={() => setTaskSortMode('order')}
                                        className={`px-3 py-1.5 rounded-lg text-[9px] font-bold uppercase tracking-wider transition-all ${
                                            taskSortMode === 'order'
                                                ? 'bg-orange-500 text-white'
                                                : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                                        }`}
                                    >
                                        Task Order
                                    </button>
                                    <button
                                        onClick={() => setTaskSortMode('actions')}
                                        className={`px-3 py-1.5 rounded-lg text-[9px] font-bold uppercase tracking-wider transition-all ${
                                            taskSortMode === 'actions'
                                                ? 'bg-orange-500 text-white'
                                                : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                                        }`}
                                    >
                                        Actions
                                    </button>
                                </div>
                            </div>

                            {/* Tasks List */}
                            <div className="space-y-3">
                                {uniquePlaygroundPoints.length === 0 ? (
                                    <div className="text-center py-8">
                                        <p className="text-[10px] text-slate-500 uppercase tracking-wide">No tasks in zone yet</p>
                                        <p className="text-[9px] text-slate-600 mt-2">Use the buttons above to add your first task</p>
                                    </div>
                                ) : (
                                    <div className="space-y-1">
                                        {(() => {
                                            // Helper function to get original task index
                                            const getOriginalTaskIndex = (taskId: string): number => {
                                                return uniquePlaygroundPoints.findIndex(p => p.id === taskId);
                                            };

                                            // Helper function to render a single task item
                                            const renderTaskItem = (
                                                point: GamePoint,
                                                renderContext: {
                                                    isNested?: boolean;
                                                    sourceTask?: GamePoint;
                                                    actionType?: 'onOpen' | 'onCorrect' | 'onIncorrect';
                                                } = {}
                                            ) => {
                                                const { isNested = false, sourceTask, actionType } = renderContext;
                                                const originalIndex = getOriginalTaskIndex(point.id);
                                                const taskNumber = String(originalIndex + 1).padStart(2, '0');

                                                // Calculate action info
                                                const hasSourceOnOpen = point.logic?.onOpen?.length > 0;
                                                const hasSourceOnCorrect = point.logic?.onCorrect?.length > 0;
                                                const hasSourceOnIncorrect = point.logic?.onIncorrect?.length > 0;

                                                const hasTargetOnOpen = uniquePlaygroundPoints.some(p =>
                                                    p.id !== point.id && p.logic?.onOpen?.some((a: any) => (a.targetId || a) === point.id)
                                                );
                                                const hasTargetOnCorrect = uniquePlaygroundPoints.some(p =>
                                                    p.id !== point.id && p.logic?.onCorrect?.some((a: any) => (a.targetId || a) === point.id)
                                                );
                                                const hasTargetOnIncorrect = uniquePlaygroundPoints.some(p =>
                                                    p.id !== point.id && p.logic?.onIncorrect?.some((a: any) => (a.targetId || a) === point.id)
                                                );

                                                const isMarked = markedTaskIds.has(point.id);
                                                const isHovered = hoveredTaskId === point.id;
                                                const hasActions = hasSourceOnOpen || hasSourceOnCorrect || hasSourceOnIncorrect;
                                                const isSourceTask = taskSortMode === 'actions' && hasActions && !isNested;

                                                const uniqueKey = isNested
                                                    ? `${point.id}-nested-${sourceTask?.id}-${actionType}`
                                                    : point.id;

                                                return (
                                                    <div
                                                        key={uniqueKey}
                                                        className={`px-3 py-2 border rounded transition-colors group flex items-center gap-2 ${
                                                            isNested ? 'ml-6 border-l-2 border-l-orange-500' : ''
                                                        } ${
                                                            bulkIconMode
                                                                ? bulkIconSourceId === point.id
                                                                    ? 'bg-blue-500/20 border-blue-500 cursor-pointer'
                                                                    : 'bg-slate-800/50 border-slate-700 cursor-pointer'
                                                                : (isHovered
                                                                    ? 'bg-orange-500/20 border-orange-500'
                                                                    : isMarked
                                                                    ? 'bg-orange-500/20 border-orange-500'
                                                                    : 'bg-slate-800/50 border-slate-700 hover:border-orange-500 hover:bg-slate-800')
                                                        }`}
                                                        onMouseEnter={() => setHoveredTaskId(point.id)}
                                                        onMouseLeave={() => setHoveredTaskId(null)}
                                                        onClick={() => {
                                                            if (bulkIconMode) {
                                                                if (bulkIconSourceId === null) {
                                                                    setBulkIconSourceId(point.id);
                                                                } else if (bulkIconSourceId === point.id) {
                                                                    setBulkIconSourceId(null);
                                                                } else {
                                                                    toggleBulkIconTarget(point.id);
                                                                }
                                                            } else {
                                                                setSelectedTaskId(point.id);
                                                            }
                                                        }}
                                                    >
                                                        {/* Checkbox for bulk/mark mode */}
                                                        {bulkIconMode ? (
                                                            <>
                                                                {bulkIconSourceId === null ? (
                                                                    <div className="w-6 h-6 bg-blue-900/50 border-2 border-blue-400 rounded flex items-center justify-center flex-shrink-0 text-[8px] font-bold text-blue-300 cursor-pointer hover:bg-blue-800/50">
                                                                        ðŸ“Œ
                                                                    </div>
                                                                ) : bulkIconSourceId === point.id ? (
                                                                    <div className="w-6 h-6 bg-blue-600 border-2 border-blue-400 rounded flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-500/50">
                                                                        {point.iconUrl ? (
                                                                            <img src={point.iconUrl} alt="" className="w-4 h-4 object-contain" />
                                                                        ) : (
                                                                            (() => {
                                                                                const Icon = ICON_COMPONENTS[point.iconId] || ICON_COMPONENTS.default;
                                                                                return <Icon className="w-4 h-4 text-white" />;
                                                                            })()
                                                                        )}
                                                                    </div>
                                                                ) : (
                                                                    <input
                                                                        type="checkbox"
                                                                        checked={bulkIconTargets.has(point.id)}
                                                                        onChange={(e) => {
                                                                            e.stopPropagation();
                                                                            toggleBulkIconTarget(point.id);
                                                                        }}
                                                                        onClick={(e) => e.stopPropagation()}
                                                                        className="w-4 h-4 rounded border-2 border-orange-500 bg-slate-900 cursor-pointer accent-orange-500 flex-shrink-0"
                                                                        title="Click checkbox or task to select target"
                                                                    />
                                                                )}
                                                            </>
                                                        ) : isMarkMode && (
                                                            <input
                                                                type="checkbox"
                                                                checked={isMarked}
                                                                onChange={(e) => {
                                                                    e.stopPropagation();
                                                                    toggleMarkTask(point.id);
                                                                }}
                                                                className="w-4 h-4 rounded border-2 border-orange-400 bg-slate-900 cursor-pointer accent-orange-500 flex-shrink-0"
                                                                title="Mark for snapping"
                                                            />
                                                        )}

                                                        {/* Icon */}
                                                        <div className="w-5 h-5 bg-slate-700 rounded flex items-center justify-center flex-shrink-0 border border-slate-600">
                                                            {point.iconUrl ? (
                                                                <img src={point.iconUrl} alt="" className="w-3 h-3 object-contain" />
                                                            ) : (
                                                                (() => {
                                                                    const Icon = ICON_COMPONENTS[point.iconId] || ICON_COMPONENTS.default;
                                                                    return <Icon className="w-3 h-3 text-slate-400" />;
                                                                })()
                                                            )}
                                                        </div>

                                                        {/* Task number and title on one line */}
                                                        <div className="flex-1 min-w-0">
                                                            {editingTitleId === point.id ? (
                                                                <input
                                                                    type="text"
                                                                    value={editingTitleValue}
                                                                    onChange={(e) => setEditingTitleValue(e.target.value)}
                                                                    onBlur={() => {
                                                                        if (editingTitleValue.trim()) {
                                                                            updatePointDirectly(point.id, { title: editingTitleValue });
                                                                        }
                                                                        setEditingTitleId(null);
                                                                    }}
                                                                    onKeyDown={(e) => {
                                                                        if (e.key === 'Enter') {
                                                                            if (editingTitleValue.trim()) {
                                                                                updatePointDirectly(point.id, { title: editingTitleValue });
                                                                            }
                                                                            setEditingTitleId(null);
                                                                        } else if (e.key === 'Escape') {
                                                                            setEditingTitleId(null);
                                                                        }
                                                                    }}
                                                                    onClick={(e) => e.stopPropagation()}
                                                                    className="w-full bg-slate-700 border border-orange-500 rounded px-1.5 py-0.5 text-[11px] font-bold text-white outline-none focus:border-orange-400"
                                                                    autoFocus
                                                                />
                                                            ) : (
                                                                <div className="flex items-center gap-2 min-w-0">
                                                                    <p className="text-[10px] font-bold text-slate-400 uppercase flex-shrink-0">TASK {taskNumber}</p>
                                                                    <p
                                                                        className="text-[11px] font-bold text-white truncate group-hover:text-orange-300 transition-colors cursor-text flex-1"
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            setEditingTitleId(point.id);
                                                                            setEditingTitleValue(point.title);
                                                                        }}
                                                                        title="Click to edit task title"
                                                                    >
                                                                        {point.title}
                                                                    </p>
                                                                </div>
                                                            )}
                                                        </div>

                                                        {/* Score */}
                                                        {showTaskScores && (
                                                            <p className="text-[10px] font-bold text-orange-400 uppercase flex-shrink-0">
                                                                ${point.points}
                                                            </p>
                                                        )}

                                                        {/* Action indicators - tri-color system */}
                                                        {showTaskActions && (
                                                            <div className="flex items-center gap-1.5 flex-shrink-0">
                                                                {/* SOURCE indicators (this task triggers actions) */}
                                                                {hasSourceOnOpen && (
                                                                    <div
                                                                        className={`w-2 h-2 rounded-full bg-yellow-400 border-2 border-yellow-600 ${isSourceTask ? 'ring-2 ring-yellow-400 ring-offset-1 ring-offset-slate-800' : ''}`}
                                                                        title="SOURCE: When Opened action"
                                                                    />
                                                                )}
                                                                {hasSourceOnCorrect && (
                                                                    <div
                                                                        className={`w-2 h-2 rounded-full bg-green-400 border-2 border-green-600 ${isSourceTask ? 'ring-2 ring-green-400 ring-offset-1 ring-offset-slate-800' : ''}`}
                                                                        title="SOURCE: If Correct action"
                                                                    />
                                                                )}
                                                                {hasSourceOnIncorrect && (
                                                                    <div
                                                                        className={`w-2 h-2 rounded-full bg-red-400 border-2 border-red-600 ${isSourceTask ? 'ring-2 ring-red-400 ring-offset-1 ring-offset-slate-800' : ''}`}
                                                                        title="SOURCE: If Incorrect action"
                                                                    />
                                                                )}

                                                                {/* Divider if both source and target */}
                                                                {(hasSourceOnOpen || hasSourceOnCorrect || hasSourceOnIncorrect) &&
                                                                 (hasTargetOnOpen || hasTargetOnCorrect || hasTargetOnIncorrect) && (
                                                                    <div className="w-px h-3 bg-slate-600" />
                                                                )}

                                                                {/* TARGET indicators (other tasks point to this task) */}
                                                                {hasTargetOnOpen && (
                                                                    <div
                                                                        className="w-2 h-2 rounded-full bg-yellow-400/40 border border-yellow-500"
                                                                        title="TARGET: Unlocked by 'When Opened' action"
                                                                    />
                                                                )}
                                                                {hasTargetOnCorrect && (
                                                                    <div
                                                                        className="w-2 h-2 rounded-full bg-green-400/40 border border-green-500"
                                                                        title="TARGET: Unlocked by 'If Correct' action"
                                                                    />
                                                                )}
                                                                {hasTargetOnIncorrect && (
                                                                    <div
                                                                        className="w-2 h-2 rounded-full bg-red-400/40 border border-red-500"
                                                                        title="TARGET: Unlocked by 'If Incorrect' action"
                                                                    />
                                                                )}
                                                            </div>
                                                        )}

                                                        {/* Edit button */}
                                                        <Edit2 className="w-3.5 h-3.5 text-slate-500 group-hover:text-orange-500 transition-colors flex-shrink-0" />
                                                    </div>
                                                );
                                            };

                                            if (taskSortMode === 'order') {
                                                // Simple list in original order
                                                return uniquePlaygroundPoints.map((point) => renderTaskItem(point));
                                            } else {
                                                // Hierarchical action-based view
                                                const renderedItems: JSX.Element[] = [];

                                                // First, render SOURCE tasks with their targets
                                                const sourceTasks = uniquePlaygroundPoints.filter(p =>
                                                    p.logic?.onOpen?.length > 0 ||
                                                    p.logic?.onCorrect?.length > 0 ||
                                                    p.logic?.onIncorrect?.length > 0
                                                );

                                                if (sourceTasks.length > 0) {
                                                    renderedItems.push(
                                                        <div key="header-source" className="flex items-center gap-2 py-2 px-2 mt-3 mb-1">
                                                            <div className="flex-1 h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent" />
                                                            <span className="text-[9px] font-black uppercase tracking-widest text-slate-500">
                                                                âš¡ SOURCE Tasks
                                                            </span>
                                                            <div className="flex-1 h-px bg-gradient-to-r from-slate-600 via-transparent to-transparent" />
                                                        </div>
                                                    );

                                                    sourceTasks.forEach(sourceTask => {
                                                        const isCollapsed = collapsedSources.has(sourceTask.id);

                                                        // Render source task with collapse/expand button
                                                        renderedItems.push(
                                                            <div key={`source-${sourceTask.id}`} className="space-y-1">
                                                                <div className="flex items-start gap-1">
                                                                    {/* Collapse/Expand button */}
                                                                    <button
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            const newCollapsed = new Set(collapsedSources);
                                                                            if (isCollapsed) {
                                                                                newCollapsed.delete(sourceTask.id);
                                                                            } else {
                                                                                newCollapsed.add(sourceTask.id);
                                                                            }
                                                                            setCollapsedSources(newCollapsed);
                                                                        }}
                                                                        className="mt-2 p-1 rounded hover:bg-slate-700 transition-colors flex-shrink-0"
                                                                        title={isCollapsed ? 'Expand to show target tasks' : 'Collapse to hide target tasks'}
                                                                    >
                                                                        <ChevronRight className={`w-4 h-4 text-slate-400 transition-transform ${!isCollapsed ? 'rotate-90' : ''}`} />
                                                                    </button>
                                                                    <div className="flex-1">
                                                                        {renderTaskItem(sourceTask)}
                                                                    </div>
                                                                </div>

                                                                {/* Render target tasks when expanded */}
                                                                {!isCollapsed && (
                                                                    <div className="space-y-1">
                                                                        {/* onOpen targets */}
                                                                        {sourceTask.logic?.onOpen?.map((action: any) => {
                                                                            const targetId = action.targetId || action;
                                                                            const targetTask = uniquePlaygroundPoints.find(p => p.id === targetId);
                                                                            if (!targetTask) return null;
                                                                            return renderTaskItem(targetTask, {
                                                                                isNested: true,
                                                                                sourceTask,
                                                                                actionType: 'onOpen'
                                                                            });
                                                                        })}

                                                                        {/* onCorrect targets */}
                                                                        {sourceTask.logic?.onCorrect?.map((action: any) => {
                                                                            const targetId = action.targetId || action;
                                                                            const targetTask = uniquePlaygroundPoints.find(p => p.id === targetId);
                                                                            if (!targetTask) return null;
                                                                            return renderTaskItem(targetTask, {
                                                                                isNested: true,
                                                                                sourceTask,
                                                                                actionType: 'onCorrect'
                                                                            });
                                                                        })}

                                                                        {/* onIncorrect targets */}
                                                                        {sourceTask.logic?.onIncorrect?.map((action: any) => {
                                                                            const targetId = action.targetId || action;
                                                                            const targetTask = uniquePlaygroundPoints.find(p => p.id === targetId);
                                                                            if (!targetTask) return null;
                                                                            return renderTaskItem(targetTask, {
                                                                                isNested: true,
                                                                                sourceTask,
                                                                                actionType: 'onIncorrect'
                                                                            });
                                                                        })}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        );
                                                    });
                                                }

                                                // TARGET TASKS section removed - all targets are now only visible under their source tasks

                                                // Finally, render tasks with no actions
                                                const noActionTasks = uniquePlaygroundPoints.filter(p => {
                                                    const isSource = p.logic?.onOpen?.length > 0 ||
                                                                   p.logic?.onCorrect?.length > 0 ||
                                                                   p.logic?.onIncorrect?.length > 0;
                                                    const isTarget = uniquePlaygroundPoints.some(other =>
                                                        other.id !== p.id && (
                                                            other.logic?.onOpen?.some((a: any) => (a.targetId || a) === p.id) ||
                                                            other.logic?.onCorrect?.some((a: any) => (a.targetId || a) === p.id) ||
                                                            other.logic?.onIncorrect?.some((a: any) => (a.targetId || a) === p.id)
                                                        )
                                                    );
                                                    return !isSource && !isTarget;
                                                });

                                                if (noActionTasks.length > 0) {
                                                    renderedItems.push(
                                                        <div key="header-noaction" className="flex items-center gap-2 py-2 px-2 mt-3 mb-1">
                                                            <div className="flex-1 h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent" />
                                                            <span className="text-[9px] font-black uppercase tracking-widest text-slate-500">
                                                                ðŸ“‹ No Actions
                                                            </span>
                                                            <div className="flex-1 h-px bg-gradient-to-r from-slate-600 via-transparent to-transparent" />
                                                        </div>
                                                    );

                                                    noActionTasks.forEach(task => {
                                                        renderedItems.push(renderTaskItem(task));
                                                    });
                                                }

                                                return renderedItems;
                                            }
                                        })()}
                                    </div>
                                )}
                            </div>
                        </>
                    )}
                </div>

                {/* Footer */}
                <div className="p-5 border-t border-slate-800 flex-shrink-0">
                    <p className="text-[9px] text-slate-500 uppercase tracking-widest text-center">Zone: <span className="text-orange-400 font-bold">{activePlayground.title}</span></p>
                </div>
            </div>

            {/* AI Icon Prompt Modal */}
            {showAiIconPrompt && (
                <div className="fixed inset-0 z-[6500] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="w-full max-w-md bg-[#0f172a] border border-slate-700 rounded-2xl shadow-2xl overflow-hidden">
                        <div className="p-4 border-b border-slate-700 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <Wand2 className="w-4 h-4 text-purple-400" />
                                <h3 className="text-xs font-black uppercase tracking-widest text-white">
                                    GENERATE {selectedTask ? 'TASK' : 'ZONE'} ICON
                                </h3>
                            </div>
                            <button
                                onClick={() => setShowAiIconPrompt(false)}
                                className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
                                type="button"
                                title="Close"
                            >
                                <X className="w-4 h-4" />
                            </button>
                        </div>
                        <div className="p-4 space-y-3">
                            <p className="text-[10px] font-bold uppercase tracking-wider text-slate-400">Describe the icon you want (e.g. â€œred flagâ€, â€œgold starâ€, â€œcameraâ€).</p>
                            <input
                                value={aiIconPromptValue}
                                onChange={(e) => setAiIconPromptValue(e.target.value)}
                                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-3 text-sm font-bold text-white outline-none focus:border-purple-500"
                                placeholder="TYPE KEYWORDS..."
                                autoFocus
                            />
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowAiIconPrompt(false)}
                                    className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 text-slate-200 rounded-xl font-black uppercase tracking-widest text-[10px] transition-colors"
                                    type="button"
                                >
                                    CANCEL
                                </button>
                                <button
                                    onClick={async () => {
                                        setShowAiIconPrompt(false);
                                        await handleGenerateTaskIcon(aiIconPromptValue);
                                    }}
                                    className="flex-1 py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-xl font-black uppercase tracking-widest text-[10px] transition-colors"
                                    type="button"
                                >
                                    GENERATE
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Logo Search Prompt Modal */}
            {showLogoPrompt && (
                <div className="fixed inset-0 z-[6500] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="w-full max-w-md bg-[#0f172a] border border-slate-700 rounded-2xl shadow-2xl overflow-hidden">
                        <div className="p-4 border-b border-slate-700 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <Globe className="w-4 h-4 text-blue-400" />
                                <h3 className="text-xs font-black uppercase tracking-widest text-white">COMPANY LOGO SEARCH</h3>
                            </div>
                            <button
                                onClick={() => setShowLogoPrompt(false)}
                                className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
                                type="button"
                                title="Close"
                            >
                                <X className="w-4 h-4" />
                            </button>
                        </div>
                        <div className="p-4 space-y-3">
                            <p className="text-[10px] font-bold uppercase tracking-wider text-slate-400">
                                Enter the company name to search for its logo online (e.g. "Nike", "Coca-Cola", "Apple")
                            </p>
                            <input
                                value={logoCompanyName}
                                onChange={(e) => setLogoCompanyName(e.target.value)}
                                onKeyDown={(e) => {
                                    if (e.key === 'Enter' && !isSearchingLogo && logoCompanyName.trim()) {
                                        handleSearchCompanyLogo(logoCompanyName);
                                    }
                                }}
                                disabled={isSearchingLogo}
                                className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-3 text-sm font-bold text-white outline-none focus:border-blue-500 disabled:opacity-50"
                                placeholder="COMPANY NAME..."
                                autoFocus
                            />
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowLogoPrompt(false)}
                                    disabled={isSearchingLogo}
                                    className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 disabled:opacity-50 text-slate-200 rounded-xl font-black uppercase tracking-widest text-[10px] transition-colors"
                                    type="button"
                                >
                                    CANCEL
                                </button>
                                <button
                                    onClick={() => handleSearchCompanyLogo(logoCompanyName)}
                                    disabled={!logoCompanyName.trim() || isSearchingLogo}
                                    className="flex-1 py-3 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white rounded-xl font-black uppercase tracking-widest text-[10px] transition-colors flex items-center justify-center gap-2"
                                    type="button"
                                >
                                    {isSearchingLogo ? (
                                        <>
                                            <div className="w-3 h-3 border-2 border-white border-t-transparent rounded-full animate-spin" />
                                            SEARCHING...
                                        </>
                                    ) : (
                                        <>
                                            <Globe className="w-3 h-3" />
                                            SEARCH LOGO
                                        </>
                                    )}
                                </button>
                            </div>
                            <div className="pt-3 border-t border-slate-700">
                                <p className="text-[8px] text-slate-500 uppercase tracking-wide">
                                    â„¹ï¸ This will search online databases (Clearbit, Google) for the company's official logo
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* AI Background Prompt Modal */}
            {showAiBackgroundPrompt && (
                <div className="fixed inset-0 z-[6500] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="w-full max-w-md bg-[#0f172a] border border-slate-700 rounded-2xl shadow-2xl overflow-hidden">
                        <div className="p-4 border-b border-slate-700 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <Wand2 className="w-4 h-4 text-purple-400" />
                                <h3 className="text-xs font-black uppercase tracking-widest text-white">AI BACKGROUND GENERATOR</h3>
                            </div>
                            <button
                                onClick={() => setShowAiBackgroundPrompt(false)}
                                className="p-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
                                type="button"
                                title="Close"
                                disabled={isGeneratingBackground}
                            >
                                <X className="w-4 h-4" />
                            </button>
                        </div>
                        <div className="p-4 space-y-3">
                            <div className="space-y-2">
                                <p className="text-[10px] font-bold uppercase tracking-wider text-slate-400">
                                    Describe the background you want. Examples: "forest at sunset", "futuristic city", "underwater temple", "medieval castle"
                                </p>
                                <div className="bg-blue-900/20 border border-blue-600/30 rounded-lg p-2">
                                    <p className="text-[9px] text-blue-200 uppercase font-bold flex items-center gap-1">
                                        <Wand2 className="w-3 h-3" /> Powered by Gemini 2.5 Flash
                                    </p>
                                    <p className="text-[8px] text-blue-300/80 mt-1">Uses Gemini's built-in image generation. Note: Imagen 3 (higher quality) requires Vertex AI and is not available with API keys.</p>
                                </div>
                            </div>
                            <div>
                                <label className="text-[9px] font-bold uppercase text-slate-500 mb-1 block">Zone: <span className="text-orange-400">{activePlayground?.title || 'Unknown'}</span></label>
                                <textarea
                                    value={aiBackgroundPromptValue}
                                    onChange={(e) => setAiBackgroundPromptValue(e.target.value)}
                                    onKeyDown={(e) => {
                                        if (e.key === 'Enter' && e.ctrlKey && !isGeneratingBackground) {
                                            handleGenerateAiBackground(aiBackgroundPromptValue);
                                        }
                                    }}
                                    disabled={isGeneratingBackground}
                                    className="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-3 text-sm font-bold text-white outline-none focus:border-purple-500 disabled:opacity-50 resize-none"
                                    placeholder="ENTER KEYWORDS..."
                                    rows={4}
                                    autoFocus
                                />
                                <p className="text-[8px] text-slate-500 mt-1 uppercase">Tip: Press Ctrl+Enter to generate</p>
                            </div>
                            <button
                                onClick={() => handleGenerateAiBackground(aiBackgroundPromptValue)}
                                disabled={!aiBackgroundPromptValue.trim() || isGeneratingBackground}
                                className="w-full py-3 bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 disabled:opacity-50 text-white rounded-xl font-black uppercase tracking-widest text-[10px] transition-colors"
                                type="button"
                            >
                                {isGeneratingBackground ? 'GENERATING...' : 'GENERATE'}
                            </button>
                            {activePlayground?.imageUrl && (
                                <div className="pt-3 border-t border-slate-700 text-[9px] text-slate-400">
                                    <p className="font-bold mb-1">Current Background:</p>
                                    <img src={activePlayground.imageUrl} alt="Current background" className="w-full h-auto rounded-lg max-h-24 object-cover" />
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* Task Action Modal */}
            {showActionModal && selectedTask && (
                <TaskActionModal
                    point={selectedTask}
                    allPoints={uniquePlaygroundPoints}
                    playgrounds={game.playgrounds}
                    onClose={() => setShowActionModal(false)}
                    onSave={(updatedPoint) => {
                        onUpdateGame({
                            ...game,
                            points: game.points.map(p => p.id === updatedPoint.id ? updatedPoint : p)
                        });
                        setShowActionModal(false);
                    }}
                    onStartDrawMode={(trigger) => {
                        // Enter draw mode: highlight source, allow clicking targets
                        setDrawMode({
                            active: true,
                            trigger,
                            sourceTaskId: selectedTask.id,
                            mousePosition: null
                        });
                        setShowActionModal(false);
                        // Show toast/instruction
                        console.log(`Draw mode activated for ${trigger}. Click tasks to connect.`);
                    }}
                />
            )}

            {/* Task Settings Modal */}
            {showTaskSettingsModal && settingsModalTaskId && selectedTask?.id === settingsModalTaskId && selectedTask && (
                <TaskEditor
                    point={selectedTask}
                    requestedTab="SETTINGS"
                    gameMode="playzone"
                    onSave={(updatedPoint) => {
                        onUpdateGame({
                            ...game,
                            points: game.points.map(p => p.id === updatedPoint.id ? updatedPoint : p)
                        });
                        setShowTaskSettingsModal(false);
                        setSettingsModalTaskId(null);
                    }}
                    onDelete={(pointId) => {
                        onUpdateGame({
                            ...game,
                            points: game.points.filter(p => p.id !== pointId)
                        });
                        setShowTaskSettingsModal(false);
                        setSettingsModalTaskId(null);
                    }}
                    onClose={() => {
                        setShowTaskSettingsModal(false);
                        setSettingsModalTaskId(null);
                    }}
                />
            )}

            {/* Task View Modal - Preview Task */}
            {showTaskViewModal && selectedTask && (
                <div className="fixed inset-0 z-[6500] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
                    <div className="bg-slate-900 border border-blue-600/50 w-full max-w-2xl max-h-[90vh] rounded-2xl overflow-hidden flex flex-col shadow-2xl">
                        {/* Header */}
                        <div className="p-5 border-b border-slate-800 bg-gradient-to-r from-blue-600 to-blue-700 flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-xl bg-white/10 border border-white/20 flex items-center justify-center">
                                    <Eye className="w-5 h-5 text-white" />
                                </div>
                                <div>
                                    <h2 className="text-lg font-black text-white uppercase tracking-widest">TASK PREVIEW</h2>
                                    <p className="text-xs text-blue-100 font-bold uppercase tracking-wider mt-0.5">{selectedTask.title}</p>
                                </div>
                            </div>
                            <button
                                onClick={() => setShowTaskViewModal(false)}
                                className="p-2 hover:bg-white/10 rounded-full text-white/80 hover:text-white transition-colors"
                            >
                                <X className="w-6 h-6" />
                            </button>
                        </div>

                        {/* Content */}
                        <div className="flex-1 overflow-y-auto p-6 space-y-6">
                            {/* Task Type Badge */}
                            <div className="flex items-center gap-3">
                                <span className="px-4 py-2 bg-blue-600/20 border border-blue-600/40 text-blue-300 rounded-lg font-black uppercase text-xs tracking-widest">
                                    {selectedTask.task.type === 'text' && 'âœï¸ TEXT ANSWER'}
                                    {selectedTask.task.type === 'multiple_choice' && 'â˜‘ï¸ MULTIPLE CHOICE'}
                                    {selectedTask.task.type === 'boolean' && 'âœ“/âœ— TRUE/FALSE'}
                                    {selectedTask.task.type === 'slider' && 'ðŸŽšï¸ SLIDER'}
                                    {selectedTask.task.type === 'checkbox' && 'â˜‘ï¸ CHECKBOXES'}
                                    {selectedTask.task.type === 'dropdown' && 'ðŸ“‹ DROPDOWN'}
                                </span>
                                <span className="px-3 py-1.5 bg-orange-600/20 border border-orange-600/40 text-orange-300 rounded-lg font-bold text-xs">
                                    {selectedTask.points || 100} POINTS
                                </span>
                            </div>

                            {/* Question */}
                            <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-5 space-y-2">
                                <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">QUESTION</label>
                                <div
                                    className="text-base font-bold text-white leading-relaxed"
                                    dangerouslySetInnerHTML={{ __html: selectedTask.task.question || 'No question set' }}
                                />
                            </div>

                            {/* Task Image */}
                            {selectedTask.task.imageUrl && (
                                <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-4">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-3 block">TASK IMAGE</label>
                                    <img
                                        src={selectedTask.task.imageUrl}
                                        alt="Task illustration"
                                        className="w-full rounded-lg max-h-64 object-cover"
                                    />
                                </div>
                            )}

                            {/* Answer Options & Correct Answers */}
                            {(selectedTask.task.type === 'multiple_choice' || selectedTask.task.type === 'checkbox' || selectedTask.task.type === 'dropdown') && selectedTask.task.options && selectedTask.task.options.length > 0 && (
                                <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-5 space-y-3">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">ANSWER OPTIONS</label>
                                    <div className="space-y-2">
                                        {selectedTask.task.options.map((option, idx) => {
                                            const isCorrect = selectedTask.task.correctAnswers?.includes(option);
                                            return (
                                                <div
                                                    key={idx}
                                                    className={`p-3 rounded-lg border-2 flex items-center gap-3 ${
                                                        isCorrect
                                                            ? 'bg-green-600/20 border-green-500 text-green-300'
                                                            : 'bg-slate-700/50 border-slate-600 text-slate-300'
                                                    }`}
                                                >
                                                    <div className={`w-6 h-6 rounded-full flex items-center justify-center font-black text-xs ${
                                                        isCorrect ? 'bg-green-500 text-white' : 'bg-slate-600 text-slate-400'
                                                    }`}>
                                                        {isCorrect ? 'âœ“' : String.fromCharCode(65 + idx)}
                                                    </div>
                                                    <span className="font-bold text-sm flex-1">{option}</span>
                                                    {isCorrect && (
                                                        <span className="px-2 py-1 bg-green-600 text-white rounded text-[8px] font-black uppercase tracking-wider">
                                                            CORRECT
                                                        </span>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {/* Text Answer */}
                            {selectedTask.task.type === 'text' && selectedTask.task.answer && (
                                <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-5 space-y-2">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">CORRECT ANSWER</label>
                                    <div className="p-3 bg-green-600/20 border-2 border-green-500 rounded-lg">
                                        <p className="text-green-300 font-bold">{selectedTask.task.answer}</p>
                                    </div>
                                </div>
                            )}

                            {/* Boolean Answer */}
                            {selectedTask.task.type === 'boolean' && selectedTask.task.answer !== undefined && (
                                <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-5 space-y-2">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">CORRECT ANSWER</label>
                                    <div className="p-3 bg-green-600/20 border-2 border-green-500 rounded-lg">
                                        <p className="text-green-300 font-black text-lg uppercase">
                                            {selectedTask.task.answer === 'true' || selectedTask.task.answer === true ? 'âœ“ TRUE' : 'âœ— FALSE'}
                                        </p>
                                    </div>
                                </div>
                            )}

                            {/* Slider Range */}
                            {selectedTask.task.type === 'slider' && selectedTask.task.range && (
                                <div className="bg-slate-800/50 border border-slate-700 rounded-xl p-5 space-y-3">
                                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest">SLIDER SETTINGS</label>
                                    <div className="grid grid-cols-3 gap-3">
                                        <div className="p-3 bg-slate-700 rounded-lg">
                                            <p className="text-[9px] text-slate-400 uppercase font-bold mb-1">Minimum</p>
                                            <p className="text-white font-black text-lg">{selectedTask.task.range.min}</p>
                                        </div>
                                        <div className="p-3 bg-green-600/20 border-2 border-green-500 rounded-lg">
                                            <p className="text-[9px] text-green-400 uppercase font-bold mb-1">Correct</p>
                                            <p className="text-green-300 font-black text-lg">{selectedTask.task.range.correctValue}</p>
                                        </div>
                                        <div className="p-3 bg-slate-700 rounded-lg">
                                            <p className="text-[9px] text-slate-400 uppercase font-bold mb-1">Maximum</p>
                                            <p className="text-white font-black text-lg">{selectedTask.task.range.max}</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Hint */}
                            {selectedTask.feedback?.hint && (
                                <div className="bg-yellow-600/10 border border-yellow-600/30 rounded-xl p-5 space-y-2">
                                    <label className="text-[10px] font-black text-yellow-500 uppercase tracking-widest flex items-center gap-2">
                                        ðŸ’¡ HINT
                                        {selectedTask.feedback.hintCost > 0 && (
                                            <span className="text-[8px] px-2 py-0.5 bg-yellow-600/30 rounded">
                                                -{selectedTask.feedback.hintCost} PTS
                                            </span>
                                        )}
                                    </label>
                                    <p className="text-yellow-200 font-medium text-sm">{selectedTask.feedback.hint}</p>
                                </div>
                            )}
                        </div>

                        {/* Footer */}
                        <div className="p-4 bg-slate-950 border-t border-slate-800">
                            <button
                                onClick={() => setShowTaskViewModal(false)}
                                className="w-full px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-black uppercase text-xs tracking-widest transition-colors"
                            >
                                CLOSE PREVIEW
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Playzone Selector Modal - For choosing which playzone to add tasks to */}
            {showPlayzoneSelector && (
                <div className="fixed inset-0 z-[9000] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="w-full max-w-2xl bg-slate-900 rounded-2xl shadow-2xl overflow-hidden border-2 border-orange-500">
                        {/* Header */}
                        <div className="bg-orange-600 px-6 py-4">
                            <h2 className="text-lg font-black text-white uppercase tracking-widest">SELECT DESTINATION</h2>
                            <p className="text-[10px] text-orange-100 font-bold uppercase tracking-wider mt-1">{pendingTasksToAdd.length} task{pendingTasksToAdd.length !== 1 ? 's' : ''} ready to add</p>
                        </div>

                        {/* Content */}
                        <div className={`p-6 ${isAddingTaskList ? 'grid grid-cols-1' : 'grid grid-cols-1 md:grid-cols-2'} gap-6`}>
                          {/* MAP Section - Only show when not adding from playzone editor */}
                          {!isAddingTaskList && (
                          <div>
                            <h3 className="text-xs font-black text-slate-300 uppercase tracking-widest mb-3 pb-2 border-b border-slate-700">MAP</h3>
                            <button
                              onClick={() => {
                                // Add the pending tasks to the MAP (no playgroundId)
                                const mapPoints = game.points?.filter(p => !p.playgroundId);
                                const baseOrder = mapPoints?.length || 0;

                                // Filter out duplicates (by title match)
                                const newTasksToAdd = pendingTasksToAdd.filter(t =>
                                  !game.points?.some(p => p.title === t.title)
                                );

                                if (newTasksToAdd.length === 0) {
                                  alert('All tasks already exist in this game. No duplicates were added.');
                                  return;
                                }

                                const newPoints: GamePoint[] = newTasksToAdd.map((t, i) => {
                                  const templateAny = t as any;
                                  const radiusMeters = typeof templateAny.radiusMeters === 'number' ? templateAny.radiusMeters : 30;
                                  const areaColor = typeof templateAny.areaColor === 'string' ? templateAny.areaColor : undefined;
                                  const openingAudioUrl = typeof templateAny.openingAudioUrl === 'string' ? templateAny.openingAudioUrl : undefined;

                                  return {
                                    id: `m-${Date.now()}-${i}-${Math.random().toString(36).slice(2, 8)}`,
                                    title: t.title,
                                    shortIntro: (t as any).intro,
                                    task: t.task,
                                    location: { lat: 0, lng: 0 },
                                    radiusMeters,
                                    activationTypes: t.activationTypes || ['radius'], // Use task's activation types or default to radius for map
                                    manualUnlockCode: undefined,
                                    iconId: t.iconId || 'default',
                                    iconUrl: (t as any).iconUrl,
                                    areaColor,
                                    openingAudioUrl,
                                    points: t.points || 100,
                                    isUnlocked: true,
                                    isCompleted: false,
                                    order: baseOrder + i,
                                    tags: t.tags,
                                    feedback: t.feedback,
                                    settings: t.settings,
                                    logic: t.logic,
                                    completionLogic: (t as any).completionLogic
                                  } as GamePoint;
                                });

                                onUpdateGame({
                                  ...game,
                                  points: [...game.points, ...newPoints]
                                });

                                // Save templates to library and sync to Supabase
                                (async () => {
                                  const { ok } = await db.saveTemplates(newTasksToAdd);
                                  if (!ok) {
                                    console.error('[PlaygroundEditor] Failed to save tasks to library');
                                  } else {
                                    console.log('[PlaygroundEditor] Tasks saved to library:', newTasksToAdd.length);
                                  }
                                })();

                                // Reset state
                                setShowPlayzoneSelector(false);
                                setPendingTasksToAdd([]);
                                setIsAddingAITasks(false);
                                setIsAddingTaskList(false);
                                if (isAddingAITasks) {
                                  setShowAiTaskGenerator(false);
                                } else {
                                  setShowTaskMaster(false);
                                }
                              }}
                              className="w-full p-4 bg-blue-900/40 hover:bg-blue-800/60 border-2 border-blue-500/50 hover:border-blue-500 rounded-lg transition-colors text-left"
                            >
                              <div className="font-bold text-white uppercase tracking-widest text-sm">MAP TASKS</div>
                              <div className="text-[10px] text-slate-400 mt-1">
                                {game.points.filter(p => !p.playgroundId).length} tasks on map
                              </div>
                            </button>
                          </div>
                          )}

                          {/* PLAYZONES Section */}
                          <div>
                            <h3 className="text-xs font-black text-slate-300 uppercase tracking-widest mb-3 pb-2 border-b border-slate-700">PLAYZONES</h3>
                            <div className="space-y-3">
                              {game.playgrounds && game.playgrounds.length > 0 ? (
                                game.playgrounds.map((playzone) => (
                                  <button
                                    key={playzone.id}
                                    onClick={() => {
                                      // Add the pending tasks to the selected playzone
                                      // Filter out duplicates (by title match)
                                      const newTasksToAdd = pendingTasksToAdd.filter(t =>
                                        !game.points?.some(p => p.title === t.title)
                                      );

                                      if (newTasksToAdd.length === 0) {
                                        alert('All tasks already exist in this game. No duplicates were added.');
                                        return;
                                      }

                                      const baseOrder = uniquePlaygroundPoints.filter(p => p.playgroundId === playzone.id).length;
                                      const COLS = 3;
                                      const PADDING = 10;
                                      const ROW_HEIGHT = 18;

                                      const newPoints: GamePoint[] = newTasksToAdd.map((t, i) => {
                                        const row = Math.floor((baseOrder + i) / COLS);
                                        const col = (baseOrder + i) % COLS;
                                        const colWidth = (100 - PADDING * 2) / COLS;

                                        const x = PADDING + col * colWidth + colWidth / 2;
                                        const y = PADDING + row * ROW_HEIGHT + ROW_HEIGHT / 2;

                                        const templateAny = t as any;
                                        const radiusMeters = typeof templateAny.radiusMeters === 'number' ? templateAny.radiusMeters : 30;
                                        const areaColor = typeof templateAny.areaColor === 'string' ? templateAny.areaColor : undefined;
                                        const openingAudioUrl = typeof templateAny.openingAudioUrl === 'string' ? templateAny.openingAudioUrl : undefined;

                                        return {
                                          id: `p-${Date.now()}-${i}-${Math.random().toString(36).slice(2, 8)}`,
                                          title: t.title,
                                          shortIntro: (t as any).intro,
                                          task: t.task,
                                          location: { lat: 0, lng: 0 },
                                          radiusMeters,
                                          activationTypes: t.activationTypes || ['click'],
                                          manualUnlockCode: undefined,
                                          playgroundId: playzone.id,
                                          devicePositions: {
                                              [selectedDevice]: { x: Math.round(x * 10) / 10, y: Math.round(y * 10) / 10 }
                                          },
                                          playgroundScale: 1,
                                          isHiddenBeforeScan: false,
                                          iconId: t.iconId || 'default',
                                          iconUrl: (t as any).iconUrl,
                                          areaColor,
                                          openingAudioUrl,
                                          points: t.points || 100,
                                          isUnlocked: true,
                                          isCompleted: false,
                                          order: baseOrder + i,
                                          tags: t.tags,
                                          feedback: t.feedback,
                                          settings: t.settings,
                                          logic: t.logic,
                                          completionLogic: (t as any).completionLogic
                                        } as GamePoint;
                                      });

                                      onUpdateGame({
                                        ...game,
                                        points: [...game.points, ...newPoints]
                                      });

                                      // Save templates to library and sync to Supabase
                                      (async () => {
                                        const { ok } = await db.saveTemplates(newTasksToAdd);
                                        if (!ok) {
                                          console.error('[PlaygroundEditor] Failed to save tasks to library');
                                        } else {
                                          console.log('[PlaygroundEditor] Tasks saved to library:', newTasksToAdd.length);
                                        }
                                      })();

                                      // Reset state
                                      setShowPlayzoneSelector(false);
                                      setPendingTasksToAdd([]);
                                      setIsAddingAITasks(false);
                                      setIsAddingTaskList(false);
                                      if (isAddingAITasks) {
                                        setShowAiTaskGenerator(false);
                                      } else {
                                        setShowTaskMaster(false);
                                      }
                                    }}
                                    className="w-full p-3 bg-orange-900/40 hover:bg-orange-800/60 border-2 border-orange-500/50 hover:border-orange-500 rounded-lg transition-colors text-left"
                                    type="button"
                                  >
                                    <div className="flex items-center gap-2">
                                      <div className="w-5 h-5 bg-orange-500 rounded-md flex items-center justify-center flex-shrink-0">
                                        <MapPin className="w-3 h-3 text-white" />
                                      </div>
                                      <div className="font-bold text-white uppercase tracking-widest text-sm">{playzone.title || `Playzone ${game.playgrounds?.indexOf(playzone) + 1}`}</div>
                                    </div>
                                    <div className="text-[10px] text-slate-400 mt-1">
                                      {uniquePlaygroundPoints.filter(p => p.playgroundId === playzone.id).length} tasks
                                    </div>
                                  </button>
                                ))
                              ) : (
                                <p className="text-slate-400 text-xs italic">No playzones available</p>
                              )}
                            </div>
                          </div>
                        </div>

                        {/* Footer */}
                        <div className="border-t border-slate-700 px-6 py-3 bg-slate-950 flex items-center justify-end gap-3">
                            <button
                                onClick={() => {
                                    setShowPlayzoneSelector(false);
                                    setPendingTasksToAdd([]);
                                    setIsAddingAITasks(false);
                                    setIsAddingTaskList(false);
                                }}
                                className="px-4 py-2 text-slate-300 hover:text-white font-bold uppercase text-xs transition-colors"
                            >
                                CANCEL
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Advanced AI Task Generator (TaskMaster version) */}
            {showAiTaskGenerator && (
                <AiTaskGenerator
                    onClose={() => setShowAiTaskGenerator(false)}
                    playgrounds={game.playgrounds || []}
                    initialPlaygroundId={activePlayground?.id || null}
                    targetMode="GAME"
                    onAddTasks={(tasks, targetPlaygroundId) => {
                        // If no specific playzone selected, show selector to choose MAP or PLAYZONE
                        if (!targetPlaygroundId) {
                            setPendingTasksToAdd(tasks);
                            setIsAddingAITasks(true);
                            setShowPlayzoneSelector(true);
                            return;
                        }

                        // Otherwise, add directly to the specified or active playzone
                        const baseOrder = uniquePlaygroundPoints.length;
                        const COLS = 3;
                        const PADDING = 10;
                        const ROW_HEIGHT = 18;

                        const newPoints: GamePoint[] = tasks.map((t, i) => {
                            const row = Math.floor((baseOrder + i) / COLS);
                            const col = (baseOrder + i) % COLS;
                            const colWidth = (100 - PADDING * 2) / COLS;

                            const x = PADDING + col * colWidth + colWidth / 2;
                            const y = PADDING + row * ROW_HEIGHT + ROW_HEIGHT / 2;

                            const templateAny = t as any;
                            const radiusMeters = typeof templateAny.radiusMeters === 'number' ? templateAny.radiusMeters : 30;
                            const areaColor = typeof templateAny.areaColor === 'string' ? templateAny.areaColor : undefined;

                            return {
                                id: `p-${Date.now()}-${i}-${Math.random().toString(36).slice(2, 8)}`,
                                title: t.title,
                                shortIntro: (t as any).intro,
                                task: t.task,
                                location: { lat: 0, lng: 0 },
                                radiusMeters,
                                activationTypes: ['radius'],
                                manualUnlockCode: undefined,
                                playgroundId: targetPlaygroundId || activePlayground?.id,
                                devicePositions: {
                                    [selectedDevice]: { x: Math.round(x * 10) / 10, y: Math.round(y * 10) / 10 }
                                },
                                playgroundScale: 1,
                                isHiddenBeforeScan: false,
                                iconId: t.iconId || 'default',
                                iconUrl: (t as any).iconUrl,
                                areaColor,
                                points: t.points || 100,
                                isUnlocked: true,
                                isCompleted: false,
                                order: baseOrder + i,
                                tags: t.tags,
                                feedback: t.feedback,
                                settings: t.settings,
                                logic: t.logic,
                                completionLogic: (t as any).completionLogic
                            } as GamePoint;
                        });

                        onUpdateGame({
                            ...game,
                            points: [...game.points, ...newPoints]
                        });

                        // Save templates to library and sync to Supabase
                        (async () => {
                            const { ok } = await db.saveTemplates(tasks);
                            if (!ok) {
                                console.error('[PlaygroundEditor] Failed to save tasks to library');
                            } else {
                                console.log('[PlaygroundEditor] Tasks saved to library:', tasks.length);
                            }
                        })();
                    }}
                    onAddToLibrary={async (tasks) => {
                        const { ok } = await db.saveTemplates(tasks);
                        if (!ok) console.error('[PlaygroundEditor] Failed to save templates to library');
                    }}
                />
            )}

            {/* TaskMaster Modal for LIBRARY and TASKLIST */}
            {showTaskMaster && (
                <TaskMaster
                    onClose={() => {
                        setShowTaskMaster(false);
                        setIsAddingTaskList(false);
                    }}
                    isPlayzoneEditor={true}
                    onImportTasks={(tasks) => {
                        setPendingTasksToAdd(tasks);
                        setIsAddingAITasks(false);
                        setIsAddingTaskList(false);
                        setShowPlayzoneSelector(true);
                    }}
                    onImportTaskList={(list, destination) => {
                        if (destination === '__PLAYZONE__') {
                            const targetPlaygroundId = activePlayground?.id;
                            if (!targetPlaygroundId) {
                                alert('No active playzone selected.');
                                return;
                            }

                            const newTasksToAdd = (list.tasks || []).filter(t =>
                                !game.points?.some(p => p.title === t.title)
                            );

                            if (newTasksToAdd.length === 0) {
                                alert('All tasks already exist in this game. No duplicates were added.');
                                return;
                            }

                            const baseOrder = uniquePlaygroundPoints.filter(p => p.playgroundId === targetPlaygroundId).length;
                            const COLS = 3;
                            const PADDING = 10;
                            const ROW_HEIGHT = 18;

                            const newPoints: GamePoint[] = newTasksToAdd.map((t, i) => {
                                const row = Math.floor((baseOrder + i) / COLS);
                                const col = (baseOrder + i) % COLS;
                                const colWidth = (100 - PADDING * 2) / COLS;

                                const x = PADDING + col * colWidth + colWidth / 2;
                                const y = PADDING + row * ROW_HEIGHT + ROW_HEIGHT / 2;

                                const templateAny = t as any;
                                const radiusMeters = typeof templateAny.radiusMeters === 'number' ? templateAny.radiusMeters : 30;
                                const areaColor = typeof templateAny.areaColor === 'string' ? templateAny.areaColor : undefined;
                                const openingAudioUrl = typeof templateAny.openingAudioUrl === 'string' ? templateAny.openingAudioUrl : undefined;

                                return {
                                    id: `p-${Date.now()}-${i}-${Math.random().toString(36).slice(2, 8)}`,
                                    title: t.title,
                                    shortIntro: (t as any).intro,
                                    task: t.task,
                                    location: { lat: 0, lng: 0 },
                                    radiusMeters,
                                    activationTypes: t.activationTypes || ['click'],
                                    manualUnlockCode: undefined,
                                    playgroundId: targetPlaygroundId,
                                    devicePositions: {
                                        [selectedDevice]: { x: Math.round(x * 10) / 10, y: Math.round(y * 10) / 10 }
                                    },
                                    playgroundScale: 1,
                                    isHiddenBeforeScan: false,
                                    iconId: t.iconId || 'default',
                                    iconUrl: (t as any).iconUrl,
                                    areaColor,
                                    openingAudioUrl,
                                    points: t.points || 100,
                                    isUnlocked: true,
                                    isCompleted: false,
                                    order: baseOrder + i,
                                    tags: t.tags,
                                    feedback: t.feedback,
                                    settings: t.settings,
                                    logic: t.logic,
                                    completionLogic: (t as any).completionLogic
                                } as GamePoint;
                            });

                            onUpdateGame({
                                ...game,
                                points: [...game.points, ...newPoints]
                            });

                            // Save templates to library and sync to Supabase
                            (async () => {
                                const { ok } = await db.saveTemplates(newTasksToAdd);
                                if (!ok) {
                                    console.error('[PlaygroundEditor] Failed to save tasks to library');
                                } else {
                                    console.log('[PlaygroundEditor] Tasks saved to library:', newTasksToAdd.length);
                                }
                            })();

                            setShowTaskMaster(false);
                            return;
                        }

                        // '__GAME__' (or default): open existing destination selector (MAP or PLAYZONES)
                        setPendingTasksToAdd(list.tasks || []);
                        setIsAddingAITasks(false);
                        setIsAddingTaskList(false);
                        setShowPlayzoneSelector(true);
                    }}
                    taskLists={taskLists}
                    onUpdateTaskLists={onUpdateTaskLists}
                    taskLibrary={taskLibrary}
                    onUpdateTaskLibrary={onUpdateTaskLibrary}
                    games={[game]}
                    initialTab={taskMasterTab}
                />
            )}


            {/* Gemini API Key Modal */}
            <GeminiApiKeyModal
                isOpen={showGeminiKeyModal}
                onClose={() => setShowGeminiKeyModal(false)}
                onSave={handleApiKeySaved}
            />

            {/* QR Scanner Color Picker Modal */}
            {showQRColorPicker && (
                <div className="fixed inset-0 z-[9999] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 pointer-events-auto">
                    <div className="w-full max-w-sm bg-slate-900 rounded-2xl shadow-2xl overflow-hidden border-2 border-yellow-500">
                        {/* Header */}
                        <div className="bg-gradient-to-r from-yellow-500 to-orange-500 px-6 py-4 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <QrCode className="w-5 h-5 text-white" />
                                <h3 className="text-lg font-black text-white uppercase tracking-widest">Button Color</h3>
                            </div>
                            <button
                                onClick={() => setShowQRColorPicker(false)}
                                className="p-2 hover:bg-white/20 rounded-lg transition-colors"
                                title="Close"
                                type="button"
                            >
                                <X className="w-5 h-5 text-white" />
                            </button>
                        </div>

                        {/* Color Picker Content */}
                        <div className="p-6 space-y-4">
                            <p className="text-sm text-slate-300 font-bold uppercase tracking-wider">Choose QR Scanner Button Color</p>

                            {/* Current Color Preview */}
                            <div className="flex items-center gap-3">
                                <div
                                    className="w-16 h-16 rounded-xl border-2 border-slate-700 shadow-lg"
                                    style={{ backgroundColor: qrScannerColor }}
                                />
                                <div className="flex-1">
                                    <p className="text-xs text-slate-400 font-bold uppercase mb-1">Current Color</p>
                                    <p className="text-sm text-white font-mono bg-slate-800 px-3 py-1.5 rounded-lg">{qrScannerColor}</p>
                                </div>
                            </div>

                            {/* Color Input */}
                            <div className="space-y-2">
                                <label className="text-xs text-slate-400 font-bold uppercase">Select Color</label>
                                <input
                                    type="color"
                                    value={qrScannerColor}
                                    onChange={(e) => setQRScannerColor(e.target.value)}
                                    className="w-full h-16 bg-slate-800 border-2 border-slate-700 rounded-xl cursor-pointer hover:border-yellow-500 transition-colors"
                                />
                            </div>

                            {/* Preset Colors */}
                            <div className="space-y-2">
                                <label className="text-xs text-slate-400 font-bold uppercase">Quick Presets</label>
                                <div className="grid grid-cols-6 gap-2">
                                    {[
                                        { name: 'Orange', color: '#f97316' },
                                        { name: 'Red', color: '#ef4444' },
                                        { name: 'Pink', color: '#ec4899' },
                                        { name: 'Purple', color: '#a855f7' },
                                        { name: 'Blue', color: '#3b82f6' },
                                        { name: 'Cyan', color: '#06b6d4' },
                                        { name: 'Teal', color: '#14b8a6' },
                                        { name: 'Green', color: '#10b981' },
                                        { name: 'Lime', color: '#84cc16' },
                                        { name: 'Yellow', color: '#eab308' },
                                        { name: 'Amber', color: '#f59e0b' },
                                        { name: 'Gray', color: '#6b7280' }
                                    ].map((preset) => (
                                        <button
                                            key={preset.color}
                                            onClick={() => setQRScannerColor(preset.color)}
                                            className="w-10 h-10 rounded-lg border-2 border-slate-700 hover:border-yellow-500 hover:scale-110 transition-all shadow-md"
                                            style={{ backgroundColor: preset.color }}
                                            title={preset.name}
                                            type="button"
                                        />
                                    ))}
                                </div>
                            </div>

                            {/* Action Buttons */}
                            <div className="flex gap-3 pt-2">
                                <button
                                    onClick={() => {
                                        saveQRScannerSettings();
                                        setShowQRColorPicker(false);
                                    }}
                                    className="flex-1 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-black uppercase text-sm rounded-xl transition-all shadow-lg"
                                    type="button"
                                >
                                    Apply
                                </button>
                                <button
                                    onClick={() => setShowQRColorPicker(false)}
                                    className="px-6 py-3 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white font-bold uppercase text-sm rounded-xl transition-colors"
                                    type="button"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            )}

            {/* Ranking Leaderboard - Draggable Popup */}
            {showRanking && (
                <div
                    className="fixed z-[9999] pointer-events-auto"
                    style={{ left: rankingPos.x, top: rankingPos.y }}
                >
                    <div className="w-80 bg-slate-900 rounded-xl shadow-2xl overflow-hidden border-2 border-yellow-500">
                        {/* Draggable Header */}
                        <div
                            className="bg-gradient-to-r from-yellow-500 to-orange-500 px-4 py-3 flex items-center justify-between cursor-move touch-none"
                            onPointerDown={(e) => {
                                setIsDraggingRanking(true);
                                rankingDragOffset.current = { x: e.clientX - rankingPos.x, y: e.clientY - rankingPos.y };
                                (e.currentTarget as Element).setPointerCapture(e.pointerId);
                            }}
                            onPointerMove={(e) => {
                                if (!isDraggingRanking) return;
                                setRankingPos({ x: e.clientX - rankingDragOffset.current.x, y: e.clientY - rankingDragOffset.current.y });
                            }}
                            onPointerUp={(e) => {
                                setIsDraggingRanking(false);
                                try {
                                    (e.currentTarget as Element).releasePointerCapture(e.pointerId);
                                } catch {}
                            }}
                        >
                            <div className="flex items-center gap-2">
                                <Trophy className="w-5 h-5 text-white" />
                                <h3 className="text-lg font-black text-white uppercase tracking-widest">Ranking</h3>
                            </div>
                            <button
                                onClick={() => setShowRanking(false)}
                                className="p-1.5 hover:bg-white/20 rounded-lg transition-colors"
                                title="Close"
                                type="button"
                            >
                                <X className="w-4 h-4 text-white" />
                            </button>
                        </div>

                        {/* Leaderboard Content */}
                        <div className="p-4 space-y-2 max-h-96 overflow-y-auto">
                            {isSimulationActive && simulationTeam ? (
                                <div className="bg-gradient-to-r from-yellow-500/20 to-orange-500/20 border-2 border-yellow-500 rounded-lg p-3">
                                    <div className="flex items-center justify-between">
                                        <div className="flex items-center gap-3">
                                            <div className="text-2xl font-black text-yellow-400">#1</div>
                                            <div>
                                                <p className="text-sm font-black text-white uppercase">{simulationTeam.name}</p>
                                                <p className="text-xs text-slate-400">Simulation Mode</p>
                                            </div>
                                        </div>
                                        <div className="text-right">
                                            <p className="text-2xl font-black text-yellow-400">{simulationScore}</p>
                                            <p className="text-[10px] text-slate-400 uppercase">Points</p>
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                <div className="text-center py-8">
                                    <Trophy className="w-12 h-12 text-slate-600 mx-auto mb-3" />
                                    <p className="text-sm text-slate-400 font-bold">Start simulation to see ranking</p>
                                    <p className="text-xs text-slate-500 mt-1">Use SIMULATOR button in TOOLS</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* Simulation Task Modal */}
            {isSimulationActive && activeSimulationTaskId && (() => {
                const task = uniquePlaygroundPoints.find(p => p.id === activeSimulationTaskId);
                if (!task) return null;

                return (
                    <TaskModal
                        point={task}
                        onClose={() => setActiveSimulationTaskId(null)}
                        onComplete={(pointId, customScore) => {
                            // Update simulation score
                            const scoreDelta = customScore !== undefined ? customScore : (task.score || 0);
                            setSimulationScore(prev => prev + scoreDelta);

                            // Update task status
                            const updatedPoints = game.points.map(p =>
                                p.id === pointId
                                    ? { ...p, isCompleted: true, isCorrect: true }
                                    : p
                            );
                            onUpdateGame({ ...game, points: updatedPoints });

                            // Close modal
                            setActiveSimulationTaskId(null);
                        }}
                        onPenalty={(amount) => {
                            // Handle penalties in simulation mode
                            setSimulationScore(prev => Math.max(0, prev - amount));
                        }}
                        distance={0}
                        mode={GameMode.SIMULATION}
                        game={game}
                    />
                );
            })()}

            {/* QR Scanner Modal - Active in simulation mode */}
            {isSimulationActive && (
                <QRScannerModal
                    isOpen={isQRScannerActive}
                    onClose={() => setIsQRScannerActive(false)}
                    onScan={handleQRScan}
                />
            )}
        </div>
    );
};

export default PlaygroundEditor;
